<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Fractional Reserve Vault dApp v4.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn {
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s, transform 0.1s;
            width: 100%;
            cursor: pointer;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        .tab-inactive {
            background-color: #374151;
            color: #d1d5db;
        }
        .loader {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4 md:p-8">

    <!-- Status/Notification Message -->
    <div id="statusMessage" class="fixed top-4 right-4 md:bottom-auto p-4 rounded-lg shadow-lg max-w-sm hidden border-l-4 z-50">
        <div class="flex items-center">
            <div id="statusSpinner" class="loader ease-linear rounded-full border-4 h-6 w-6 mr-4 hidden"></div>
            <div id="statusText" class="flex-grow"></div>
        </div>
    </div>

    <div class="bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-4xl">
        <div class="flex flex-col items-center mb-6">
            <h1 class="text-3xl font-bold text-center text-blue-400 mb-2">My Fractional Reserve Vault</h1>
            <p class="text-sm text-gray-400">Połączono z <span id="userAddress" class="font-mono text-xs"></span></p>
        </div>

        <div class="grid md:grid-cols-3 gap-4 mb-6 text-center">
            <div class="bg-gray-700 p-4 rounded-xl shadow-inner">
                <p class="text-sm font-semibold">Całkowite Aktywa Skarbca</p>
                <p class="text-lg text-green-400 mt-1"><span id="totalAssets">0</span> USDC</p>
            </div>
            <div class="bg-gray-700 p-4 rounded-xl shadow-inner">
                <p class="text-sm font-semibold">Kurs Wymiany Rcoin</p>
                <p class="text-lg text-yellow-400 mt-1">1 Rcoin ≈ <span id="exchangeRate">0</span> USDC</p>
            </div>
            <div class="bg-gray-700 p-4 rounded-xl shadow-inner">
                <p class="text-sm font-semibold">Twoje Saldo Rcoin</p>
                <p class="text-lg mt-1"><span id="rcoinBalance">0</span></p>
            </div>
        </div>

        <div class="bg-gray-700 p-4 rounded-xl shadow-inner mb-6">
            <h3 class="text-lg font-bold mb-2 text-blue-300">Stan Skarbca</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm text-gray-300">
                <p>Off-Chain: <span id="offChainBalance">0</span> USDC</p>
                <p>On-Chain: <span id="onChainBalance">0</span> USDC</p>
                <p>Całkowita Podaż Rcoin: <span id="rcoinTotalSupply">0</span></p>
                <p>Opłata Natychmiastowa: <span id="instantFee">0</span>%</p>
                <p>Opóźnienie Wypłaty: <span id="withdrawalDelay">0</span> dni</p>
            </div>
        </div>

        <!-- Panels Manager -->
        <div class="grid grid-cols-2 gap-2 text-center mb-6">
            <button id="tabDeposit" class="py-3 rounded-lg font-semibold transition-colors tab-active">Wpłata</button>
            <button id="tabWithdrawal" class="py-3 rounded-lg font-semibold transition-colors tab-inactive">Wypłata</button>
        </div>

        <!-- Deposit Panel -->
        <div id="panelDeposit" class="bg-gray-700 p-6 rounded-xl">
            <h3 class="text-xl font-semibold mb-4 text-blue-200">Wpłać USDC</h3>
            <p class="text-sm text-gray-400 mb-4">Wpłać USDC do skarbca i otrzymaj tokeny Rcoin.</p>
            <div class="relative mb-4">
                <input type="number" id="depositAmount" placeholder="0.00" class="w-full p-3 rounded-lg bg-gray-600 text-gray-200 border border-gray-500 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">USDC</span>
            </div>
            <button id="btnDeposit" class="w-full py-3 rounded-lg font-bold transition-colors bg-blue-600 hover:bg-blue-700 active:scale-98 text-white">Wpłać</button>
        </div>

        <!-- Withdrawal Panel -->
        <div id="panelWithdrawal" class="hidden bg-gray-700 p-6 rounded-xl">
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="tabInstant" class="py-2 px-4 rounded-lg font-semibold transition-colors tab-active">Natychmiastowa</button>
                <button id="tabDelayed" class="py-2 px-4 rounded-lg font-semibold transition-colors tab-inactive">Opóźniona</button>
            </div>

            <!-- Instant Withdrawal Panel -->
            <div id="instantWithdrawPanel">
                <h3 class="text-xl font-semibold mb-4 text-blue-200">Natychmiastowa Wypłata</h3>
                <p class="text-sm text-gray-400 mb-4">Wypłać natychmiast, płacąc opłatę w wysokości <span id="instantFeePanel">0</span>%.</p>
                <div class="relative mb-4">
                    <input type="number" id="instantWithdrawalAmount" placeholder="0.00" class="w-full p-3 rounded-lg bg-gray-600 text-gray-200 border border-gray-500 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">USDC</span>
                </div>
                <button id="btnInstantWithdrawal" class="w-full py-3 rounded-lg font-bold transition-colors bg-blue-600 hover:bg-blue-700 active:scale-98 text-white">Wypłać Natychmiast</button>
            </div>

            <!-- Delayed Withdrawal Panel -->
            <div id="delayedWithdrawPanel" class="hidden">
                <h3 class="text-xl font-semibold mb-4 text-blue-200">Opóźniona Wypłata</h3>
                <p class="text-sm text-gray-400 mb-4">Złóż wniosek o wypłatę bez opłat. Wypłata będzie dostępna po <span id="delayedWithdrawalPeriod">0</span> dniach.</p>
                <div id="userRequestStatus" class="bg-gray-800 p-3 rounded-lg text-sm mb-4 hidden">
                    <p class="text-yellow-400 font-bold">Posiadasz aktywny wniosek:</p>
                    <p>Wartość: <span id="userRequestAssets"></span> USDC</p>
                    <p>Dostępne do odbioru: <span id="userRequestUnlockTime"></span></p>
                </div>
                <div class="relative mb-4">
                    <input type="number" id="delayedWithdrawalAmount" placeholder="0.00" class="w-full p-3 rounded-lg bg-gray-600 text-gray-200 border border-gray-500 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">USDC</span>
                </div>
                <button id="btnRequestDelayedWithdrawal" class="w-full py-3 rounded-lg font-bold transition-colors bg-blue-600 hover:bg-blue-700 active:scale-98 text-white">Poproś o Wypłatę</button>
                <button id="btnFulfillDelayedWithdrawal" class="w-full py-3 rounded-lg font-bold transition-colors bg-green-600 hover:bg-green-700 active:scale-98 text-white mt-2 hidden">Odbierz Wypłatę</button>
                <button id="btnCancelDelayedWithdrawal" class="w-full py-3 rounded-lg font-bold transition-colors bg-red-600 hover:bg-red-700 active:scale-98 text-white mt-2 hidden">Anuluj Wniosek</button>
            </div>
        </div>

        <!-- Fund Manager Panel -->
        <div id="fundManagerPanel" class="hidden bg-gray-700 p-6 rounded-xl mt-6">
            <h3 class="text-xl font-semibold mb-4 text-purple-300">Panel Menedżera Funduszu</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <button id="btnTransferToManager" class="py-3 px-4 rounded-lg font-bold transition-colors bg-purple-600 hover:bg-purple-700 active:scale-98 text-white">Prześlij do Managera</button>
                <button id="btnTransferToVault" class="py-3 px-4 rounded-lg font-bold transition-colors bg-purple-600 hover:bg-purple-700 active:scale-98 text-white">Zwróć do Skarbca</button>
                <button id="btnUpdateOffChain" class="py-3 px-4 rounded-lg font-bold transition-colors bg-purple-600 hover:bg-purple-700 active:scale-98 text-white col-span-1 md:col-span-2">Aktualizuj Off-Chain</button>
            </div>

            <h4 class="text-lg font-semibold mb-2 mt-4 text-purple-300">Historia Wniosków o Wypłatę</h4>
            <div class="grid md:grid-cols-3 gap-4">
                <div>
                    <h5 class="font-bold text-yellow-400 mb-2">Do Odbioru</h5>
                    <ul id="unclaimedRequestsList" class="bg-gray-800 p-2 rounded-lg text-sm space-y-2"></ul>
                </div>
                <div>
                    <h5 class="font-bold text-blue-400 mb-2">Oczekujące</h5>
                    <ul id="pendingRequestsList" class="bg-gray-800 p-2 rounded-lg text-sm space-y-2"></ul>
                </div>
                <div>
                    <h5 class="font-bold text-gray-400 mb-2">Zakończone</h5>
                    <ul id="archivedRequestsList" class="bg-gray-800 p-2 rounded-lg text-sm space-y-2"></ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js";

        // Adresy kontraktów i ABI
        const vaultAddress = "0xfe203ef73b69c819796C3a3572609C29Dd0FaFFE"; // Zmień na swój adres
        const USDC_ADDRESS = "0x41E94Eb019C0762f9Bfcf9Fb1E58725BfB0e7582"; // Zmień na swój adres
        const vaultABI = [
            "event DelayedWithdrawalRequested(address indexed user, uint256 assetsToRedeem, uint256 unlockTime)",
            "event DelayedWithdrawalFulfilled(address indexed client, address indexed fulfiller, uint256 assetsWithdrawn)",
            "event DelayedWithdrawalCanceled(address indexed client)",
            "function deposit(uint256 assets, address receiver) external returns (uint256 shares)",
            "function instantWithdrawal(uint256 assetsToRedeem) external",
            "function requestDelayedWithdrawal(uint256 assetsToRedeem) external",
            "function fulfillDelayedWithdrawal(address client) external",
            "function cancelDelayedWithdrawal() external",
            "function asset() public view returns (address)",
            "function totalAssets() public view returns (uint256)",
            "function totalSupply() public view returns (uint256)",
            "function balanceOf(address account) public view returns (uint256)",
            "function getExchangeRate() public view returns (uint256)",
            "function getOffChainBalance() public view returns (uint256)",
            "function getDelayedWithdrawalRequest(address user) public view returns (uint256 assetsToRedeem, uint256 unlockTime)",
            "function instantWithdrawalFeeBps() public view returns (uint16)",
            "function withdrawalDelayPeriod() public view returns (uint256)",
            "function transferAssetsToFundManager(uint256 assetsToTransfer) external",
            "function transferAssetsToVault(uint256 assetsToTransfer) external",
            "function updateOffChainAssetValue(uint256 newTotalValue) external",
            "function fundManager() public view returns (address)"
        ];
        const usdcABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function balanceOf(address account) external view returns (uint256)"
        ];

        // Globalne zmienne stanu
        let provider, signer, vaultContract, usdcContract, userAddress, fundManagerAddress;

        // Elementy DOM
        const elements = {
            userAddress: document.getElementById('userAddress'),
            rcoinBalance: document.getElementById('rcoinBalance'),
            totalAssets: document.getElementById('totalAssets'),
            exchangeRate: document.getElementById('exchangeRate'),
            offChainBalance: document.getElementById('offChainBalance'),
            onChainBalance: document.getElementById('onChainBalance'),
            rcoinTotalSupply: document.getElementById('rcoinTotalSupply'),
            withdrawalDelay: document.getElementById('withdrawalDelay'),
            instantFee: document.getElementById('instantFee'),
            instantFeePanel: document.getElementById('instantFeePanel'),
            tabDeposit: document.getElementById('tabDeposit'),
            tabWithdrawal: document.getElementById('tabWithdrawal'),
            tabInstant: document.getElementById('tabInstant'),
            tabDelayed: document.getElementById('tabDelayed'),
            panelDeposit: document.getElementById('panelDeposit'),
            panelWithdrawal: document.getElementById('panelWithdrawal'),
            instantWithdrawPanel: document.getElementById('instantWithdrawPanel'),
            delayedWithdrawalPanel: document.getElementById('delayedWithdrawalPanel'),
            depositAmount: document.getElementById('depositAmount'),
            btnDeposit: document.getElementById('btnDeposit'),
            instantWithdrawalAmount: document.getElementById('instantWithdrawalAmount'),
            btnInstantWithdrawal: document.getElementById('btnInstantWithdrawal'),
            delayedWithdrawalAmount: document.getElementById('delayedWithdrawalAmount'),
            userRequestStatus: document.getElementById('userRequestStatus'),
            userRequestAssets: document.getElementById('userRequestAssets'),
            userRequestUnlockTime: document.getElementById('userRequestUnlockTime'),
            btnRequestDelayedWithdrawal: document.getElementById('btnRequestDelayedWithdrawal'),
            btnFulfillDelayedWithdrawal: document.getElementById('btnFulfillDelayedWithdrawal'),
            btnCancelDelayedWithdrawal: document.getElementById('btnCancelDelayedWithdrawal'),
            statusMessage: document.getElementById('statusMessage'),
            statusText: document.getElementById('statusText'),
            statusSpinner: document.getElementById('statusSpinner'),
            fundManagerPanel: document.getElementById('fundManagerPanel'),
            btnTransferToManager: document.getElementById('btnTransferToManager'),
            btnTransferToVault: document.getElementById('btnTransferToVault'),
            btnUpdateOffChain: document.getElementById('btnUpdateOffChain'),
            unclaimedRequestsList: document.getElementById('unclaimedRequestsList'),
            pendingRequestsList: document.getElementById('pendingRequestsList'),
            archivedRequestsList: document.getElementById('archivedRequestsList')
        };

        // Pomocnicze funkcje
        const formatAddress = (address) => `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        const formatUnits = (value, decimals) => parseFloat(ethers.utils.formatUnits(value, decimals)).toFixed(2);
        const formatTime = (seconds) => {
            const d = Math.floor(seconds / (3600*24));
            const h = Math.floor(seconds % (3600*24) / 3600);
            const m = Math.floor(seconds % 3600 / 60);
            if (d > 0) return `${d} dni, ${h} godz.`;
            if (h > 0) return `${h} godz., ${m} min.`;
            return `${m} min.`;
        };

        // Główna logika aplikacji
        async function connect() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    vaultContract = new ethers.Contract(vaultAddress, vaultABI, signer);
                    usdcContract = new ethers.Contract(USDC_ADDRESS, usdcABI, signer);
                    fundManagerAddress = await vaultContract.fundManager();
                    
                    elements.userAddress.textContent = formatAddress(userAddress);
                    updateUI();
                } catch (error) {
                    showStatus(`Błąd połączenia: ${error.message}`, 'error');
                }
            } else {
                showStatus("Proszę zainstalować MetaMask!", 'error');
            }
        }

        async function updateUI() {
            try {
                showStatus("Ładowanie danych...", 'loading');
                const [
                    rcoinBalance,
                    totalAssets,
                    rcoinTotalSupply,
                    offChainBalance,
                    onChainBalance,
                    exchangeRate,
                    instantFeeBps,
                    withdrawalDelay,
                    userRequest
                ] = await Promise.all([
                    vaultContract.balanceOf(userAddress),
                    vaultContract.totalAssets(),
                    vaultContract.totalSupply(),
                    vaultContract.getOffChainBalance(),
                    usdcContract.balanceOf(vaultAddress),
                    vaultContract.getExchangeRate(),
                    vaultContract.instantWithdrawalFeeBps(),
                    vaultContract.withdrawalDelayPeriod(),
                    vaultContract.getDelayedWithdrawalRequest(userAddress)
                ]);

                elements.rcoinBalance.textContent = formatUnits(rcoinBalance, 18);
                elements.totalAssets.textContent = formatUnits(totalAssets, 6);
                elements.exchangeRate.textContent = formatUnits(exchangeRate, 18);
                elements.offChainBalance.textContent = formatUnits(offChainBalance, 6);
                elements.onChainBalance.textContent = formatUnits(onChainBalance, 6);
                elements.rcoinTotalSupply.textContent = formatUnits(rcoinTotalSupply, 18);
                elements.withdrawalDelay.textContent = Math.floor(withdrawalDelay / 86400);
                elements.instantFee.textContent = instantFeeBps / 100;
                elements.instantFeePanel.textContent = instantFeeBps / 100;
                elements.delayedWithdrawalPeriod.textContent = Math.floor(withdrawalDelay / 86400);

                updateUserWithdrawalPanel(userRequest);
                updateFundManagerPanel();
                showStatus("Dane zaktualizowane.", 'success', true);
            } catch (error) {
                console.error("Błąd podczas aktualizacji UI:", error);
                showStatus(`Błąd podczas aktualizacji UI: ${error.message}`, 'error');
            }
        }

        function updateUserWithdrawalPanel(userRequest) {
            if (userRequest.assets.gt(0)) {
                elements.userRequestStatus.classList.remove('hidden');
                elements.userRequestAssets.textContent = formatUnits(userRequest.assets, 6);
                const unlockTime = userRequest.unlockTime.toNumber();
                const now = Math.floor(Date.now() / 1000);
                
                elements.userRequestUnlockTime.textContent = new Date(unlockTime * 1000).toLocaleString();
                
                elements.btnRequestDelayedWithdrawal.classList.add('hidden');
                elements.btnCancelDelayedWithdrawal.classList.remove('hidden');
                if (now >= unlockTime) {
                    elements.btnFulfillDelayedWithdrawal.classList.remove('hidden');
                    elements.btnCancelDelayedWithdrawal.classList.add('hidden');
                } else {
                    elements.btnFulfillDelayedWithdrawal.classList.add('hidden');
                }
            } else {
                elements.userRequestStatus.classList.add('hidden');
                elements.btnRequestDelayedWithdrawal.classList.remove('hidden');
                elements.btnFulfillDelayedWithdrawal.classList.add('hidden');
                elements.btnCancelDelayedWithdrawal.classList.add('hidden');
            }
        }

        async function updateFundManagerPanel() {
            if (userAddress.toLowerCase() === fundManagerAddress.toLowerCase()) {
                elements.fundManagerPanel.classList.remove('hidden');
                loadWithdrawalRequestsHistory();
            } else {
                elements.fundManagerPanel.classList.add('hidden');
            }
        }
        
        // --- POPRAWIONA LOGIKA HISTORII WNIOSKÓW ---
        async function loadWithdrawalRequestsHistory() {
            showStatus("Ładowanie historii wniosków...", "loading");
            try {
                // Pobierz wszystkie eventy
                const requestedEvents = await vaultContract.queryFilter('DelayedWithdrawalRequested', 0, 'latest');
                const fulfilledEvents = await vaultContract.queryFilter('DelayedWithdrawalFulfilled', 0, 'latest');
                const canceledEvents = await vaultContract.queryFilter('DelayedWithdrawalCanceled', 0, 'latest');

                // Połącz wszystkie eventy i dodaj typ dla rozróżnienia
                const allEvents = [
                    ...requestedEvents.map(ev => ({ ...ev, type: 'requested' })),
                    ...fulfilledEvents.map(ev => ({ ...ev, type: 'fulfilled' })),
                    ...canceledEvents.map(ev => ({ ...ev, type: 'canceled' }))
                ];

                // Posortuj chronologicznie (po blockNumber, potem transactionIndex)
                allEvents.sort((a, b) => {
                    if (a.blockNumber !== b.blockNumber) return a.blockNumber - b.blockNumber;
                    return a.transactionIndex - b.transactionIndex;
                });

                // Mapa wniosków: klucz to unikalny ID (np. transactionHash requested), wartość to obiekt wniosku
                const requests = new Map();
                // Mapa ostatniego aktywnego wniosku per user
                const lastRequestPerUser = new Map();

                for (const event of allEvents) {
                    const { user } = event.args;
                    const reqUser = user || event.args.client; // Użyj client dla canceled/fulfilled, jeśli user nie istnieje

                    if (event.type === 'requested') {
                        const { assetsToRedeem, unlockTime } = event.args;
                        const reqId = event.transactionHash; // Unikalny ID dla wniosku
                        const req = {
                            id: reqId,
                            user: reqUser,
                            assets: assetsToRedeem,
                            unlockTime,
                            status: 'pending',
                            event
                        };
                        requests.set(reqId, req);
                        lastRequestPerUser.set(reqUser, reqId); // Ustaw jako ostatni dla usera
                    } else if (event.type === 'fulfilled' || event.type === 'canceled') {
                        const lastReqId = lastRequestPerUser.get(reqUser);
                        if (lastReqId) {
                            const req = requests.get(lastReqId);
                            if (req && req.status === 'pending') {
                                req.status = event.type;
                            }
                            lastRequestPerUser.delete(reqUser); // Usuń, bo wniosek zakończony
                        }
                    }
                }

                // Wyczyść listy UI
                elements.unclaimedRequestsList.innerHTML = '';
                elements.pendingRequestsList.innerHTML = '';
                elements.archivedRequestsList.innerHTML = '';

                const now = Math.floor(Date.now() / 1000);
                const sixtyDaysAgo = now - (60 * 24 * 3600);
                
                const sortedRequests = Array.from(requests.values())
                    .filter(req => req.event.blockTimestamp >= sixtyDaysAgo)
                    .sort((a, b) => b.event.blockNumber - a.event.blockNumber);

                sortedRequests.forEach(req => {
                    let targetList;
                    const isReady = req.unlockTime.toNumber() <= now;

                    if (req.status === 'pending' && isReady) {
                        req.status = 'ready'; // Gotowy do odbioru
                        targetList = elements.unclaimedRequestsList;
                    } else if (req.status === 'pending' && !isReady) {
                        targetList = elements.pendingRequestsList;
                    } else {
                        targetList = elements.archivedRequestsList;
                    }

                    targetList.appendChild(createRequestListItem(req));
                });
                
                // Dodaj komunikaty, jeśli listy puste
                if (elements.unclaimedRequestsList.children.length === 0) {
                    elements.unclaimedRequestsList.innerHTML = `<li class="text-gray-500 text-center py-2">Brak wniosków do odbioru.</li>`;
                }
                if (elements.pendingRequestsList.children.length === 0) {
                    elements.pendingRequestsList.innerHTML = `<li class="text-gray-500 text-center py-2">Brak oczekujących wniosków.</li>`;
                }
                if (elements.archivedRequestsList.children.length === 0) {
                    elements.archivedRequestsList.innerHTML = `<li class="text-gray-500 text-center py-2">Brak zakończonych wniosków.</li>`;
                }

                showStatus("Historia wczytana pomyślnie.", 'success', true);
            } catch (error) {
                console.error("Błąd podczas pobierania historii wniosków:", error);
                showStatus(`Błąd ładowania historii: ${error.message}`, 'error');
            }
        }

        function createRequestListItem(req) {
            const li = document.createElement('li');
            li.className = `p-2 rounded-lg ${req.status === 'ready' ? 'bg-yellow-800' : req.status === 'pending' ? 'bg-blue-800' : 'bg-gray-800'} shadow`;

            let statusText;
            switch (req.status) {
                case 'ready':
                    statusText = 'Gotowy do odbioru';
                    break;
                case 'pending':
                    statusText = 'Oczekuje';
                    break;
                case 'fulfilled':
                    statusText = 'Odebrany';
                    break;
                case 'canceled':
                    statusText = 'Anulowany';
                    break;
            }

            const assetsFormatted = formatUnits(req.assets, 6);
            const userFormatted = formatAddress(req.user);
            const unlockTimeFormatted = new Date(req.unlockTime.toNumber() * 1000).toLocaleString();

            let content = `
                <p class="font-bold">${assetsFormatted} USDC</p>
                <p class="text-xs text-gray-400">Status: ${statusText}</p>
                <p class="text-xs text-gray-400">Adres: ${userFormatted}</p>
            `;
            if (req.status === 'pending' || req.status === 'ready') {
                const now = Math.floor(Date.now() / 1000);
                const remaining = req.unlockTime.toNumber() - now;
                content += `<p class="text-xs text-gray-400">Do odbioru: ${formatTime(remaining)}</p>`;
            } else if (req.status === 'ready') {
                content += `<p class="text-xs text-gray-400">Do odbioru: Gotowy</p>`;
            }

            li.innerHTML = content;
            return li;
        }


        // --- Funkcje do obsługi transakcji ---
        async function handleDeposit() {
            const amount = elements.depositAmount.value;
            if (!amount || amount <= 0) { showStatus("Proszę podać kwotę.", 'error'); return; }
            try {
                showStatus("Zatwierdzanie...", 'loading');
                const amountInWei = ethers.utils.parseUnits(amount, 6);
                const approvalTx = await usdcContract.approve(vaultAddress, amountInWei);
                await approvalTx.wait();
                showStatus("Wpłata w toku...", 'loading');
                const depositTx = await vaultContract.deposit(amountInWei, userAddress);
                await depositTx.wait();
                showStatus("Wpłata zakończona!", 'success', true);
                updateUI();
            } catch (error) { showStatus(`Błąd: ${error.message}`, 'error'); }
        }

        async function handleInstantWithdrawal() {
            const amount = elements.instantWithdrawalAmount.value;
            if (!amount || amount <= 0) { showStatus("Proszę podać kwotę.", 'error'); return; }
            try {
                showStatus("Wypłata w toku...", 'loading');
                const amountInWei = ethers.utils.parseUnits(amount, 6);
                const tx = await vaultContract.instantWithdrawal(amountInWei);
                await tx.wait();
                showStatus("Wypłata zakończona!", 'success', true);
                updateUI();
            } catch (error) { showStatus(`Błąd: ${error.message}`, 'error'); }
        }

        async function handleRequestDelayedWithdrawal() {
            const amount = elements.delayedWithdrawalAmount.value;
            if (!amount || amount <= 0) { showStatus("Proszę podać kwotę.", 'error'); return; }
            try {
                showStatus("Wniosek w toku...", 'loading');
                const amountInWei = ethers.utils.parseUnits(amount, 6);
                const tx = await vaultContract.requestDelayedWithdrawal(amountInWei);
                await tx.wait();
                showStatus("Wniosek złożony pomyślnie!", 'success', true);
                updateUI();
            } catch (error) { showStatus(`Błąd: ${error.message}`, 'error'); }
        }

        async function handleFulfillDelayedWithdrawal() {
            try {
                showStatus("Realizacja wypłaty...", 'loading');
                const tx = await vaultContract.fulfillDelayedWithdrawal(userAddress);
                await tx.wait();
                showStatus("Wypłata zrealizowana!", 'success', true);
                updateUI();
            } catch (error) { showStatus(`Błąd: ${error.message}`, 'error'); }
        }

        async function handleCancelDelayedWithdrawal() {
            try {
                showStatus("Anulowanie wniosku...", 'loading');
                const tx = await vaultContract.cancelDelayedWithdrawal();
                await tx.wait();
                showStatus("Wniosek anulowany!", 'success', true);
                updateUI();
            } catch (error) { showStatus(`Błąd: ${error.message}`, 'error'); }
        }

        // Funkcje menedżera
        async function handleUpdateOffChain() {
            const newValue = prompt("Podaj nową wartość off-chain w USDC:");
            if (newValue && !isNaN(newValue) && newValue > 0) {
                try {
                    showStatus("Aktualizacja wartości off-chain...", 'loading');
                    const valueInWei = ethers.utils.parseUnits(newValue, 6);
                    const tx = await vaultContract.updateOffChainAssetValue(valueInWei);
                    await tx.wait();
                    showStatus("Wartość off-chain zaktualizowana!", 'success', true);
                    updateUI();
                } catch (error) { showStatus(`Błąd: ${error.message}`, 'error'); }
            }
        }
        
        async function handleTransferToManager() {
            const amount = prompt("Podaj kwotę USDC do przesłania do menedżera:");
            if (amount && !isNaN(amount) && amount > 0) {
                try {
                    showStatus("Przesyłanie do menedżera...", 'loading');
                    const amountInWei = ethers.utils.parseUnits(amount, 6);
                    const tx = await vaultContract.transferAssetsToFundManager(amountInWei);
                    await tx.wait();
                    showStatus("Pomyślnie przesłano do menedżera!", 'success', true);
                    updateUI();
                } catch (error) { showStatus(`Błąd: ${error.message}`, 'error'); }
            }
        }

        async function handleTransferToVault() {
            const amount = prompt("Podaj kwotę USDC do zwrotu do skarbca:");
            if (amount && !isNaN(amount) && amount > 0) {
                try {
                    showStatus("Przesyłanie do skarbca...", 'loading');
                    const amountInWei = ethers.utils.parseUnits(amount, 6);
                    const tx = await vaultContract.transferAssetsToVault(amountInWei);
                    await tx.wait();
                    showStatus("Pomyślnie zwrócono do skarbca!", 'success', true);
                    updateUI();
                } catch (error) { showStatus(`Błąd: ${error.message}`, 'error'); }
            }
        }


        // Przełączanie paneli
        const switchTab = (activeTab) => {
            elements.tabDeposit.classList.toggle('tab-active', activeTab === 'deposit');
            elements.tabDeposit.classList.toggle('tab-inactive', activeTab !== 'deposit');
            elements.tabWithdrawal.classList.toggle('tab-active', activeTab === 'withdrawal');
            elements.tabWithdrawal.classList.toggle('tab-inactive', activeTab !== 'withdrawal');
            elements.panelDeposit.classList.toggle('hidden', activeTab !== 'deposit');
            elements.panelWithdrawal.classList.toggle('hidden', activeTab !== 'withdrawal');
        };

        const switchWithdrawalPanel = (activePanel) => {
            elements.tabInstant.classList.toggle('tab-active', activePanel === 'instant');
            elements.tabInstant.classList.toggle('tab-inactive', activePanel !== 'instant');
            elements.tabDelayed.classList.toggle('tab-active', activePanel === 'delayed');
            elements.tabDelayed.classList.toggle('tab-inactive', activePanel !== 'delayed');
            elements.instantWithdrawPanel.classList.toggle('hidden', activePanel !== 'instant');
            elements.delayedWithdrawalPanel.classList.toggle('hidden', activePanel !== 'delayed');
        };

        // UI dla statusu
        function showStatus(message, type = "info", autoHide = false) {
            elements.statusText.innerText = message;
            elements.statusMessage.classList.remove('hidden', 'bg-red-900', 'bg-green-900', 'bg-blue-900', 'border-red-500', 'border-green-500', 'border-blue-500');
            elements.statusSpinner.classList.add('hidden');
            
            if (type === 'loading') {
                elements.statusMessage.classList.add('bg-blue-900', 'border-blue-500');
                elements.statusSpinner.classList.remove('hidden');
            } else if (type === 'success') {
                elements.statusMessage.classList.add('bg-green-900', 'border-green-500');
            } else if (type === 'error') {
                elements.statusMessage.classList.add('bg-red-900', 'border-red-500');
            } else { // info
                elements.statusMessage.classList.add('bg-gray-800', 'border-gray-500');
            }
            if (autoHide) {
                setTimeout(() => { elements.statusMessage.classList.add('hidden'); }, 5000);
            }
        }

        // Event Listeners
        elements.tabDeposit.addEventListener('click', () => switchTab('deposit'));
        elements.tabWithdrawal.addEventListener('click', () => switchTab('withdrawal'));
        elements.tabInstant.addEventListener('click', () => switchWithdrawalPanel('instant'));
        elements.tabDelayed.addEventListener('click', () => switchWithdrawalPanel('delayed'));
        elements.btnDeposit.addEventListener('click', handleDeposit);
        elements.btnInstantWithdrawal.addEventListener('click', handleInstantWithdrawal);
        elements.btnRequestDelayedWithdrawal.addEventListener('click', handleRequestDelayedWithdrawal);
        elements.btnFulfillDelayedWithdrawal.addEventListener('click', handleFulfillDelayedWithdrawal);
        elements.btnCancelDelayedWithdrawal.addEventListener('click', handleCancelDelayedWithdrawal);
        elements.btnUpdateOffChain.addEventListener('click', handleUpdateOffChain);
        elements.btnTransferToManager.addEventListener('click', handleTransferToManager);
        elements.btnTransferToVault.addEventListener('click', handleTransferToVault);

        // Uruchomienie aplikacji
        connect();
    </script>
</body>
</html>

