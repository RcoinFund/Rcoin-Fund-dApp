<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rcoin Fund dApp v4.3 (Zaktualizowana)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .btn {
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s, transform 0.1s;
            width: 100%;
            cursor: pointer;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-blue { background-color: #3b82f6; color: white; }
        .btn-blue:hover { background-color: #2563eb; }
        .btn-red { background-color: #ef4444; color: white; }
        .btn-red:hover { background-color: #dc2626; }
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        .tab-inactive {
            background-color: #374151;
            color: #d1d5db;
        }
        .loader {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto">

        <!-- Nagłówek -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <div class="flex items-center gap-3">
                <svg class="w-10 h-10 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3-.895-3-2s1.343-2 3-2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 10v-1m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3.895 3 2-1.343 2-3 2m0 0c-1.11 0-2.08-.402-2.599-1M12 18v-1m0-10V7m0 11h.01"></path></svg>
                <h1 class="text-4xl font-bold text-white">Rcoin Fund</h1>
            </div>
            <button id="connectButton" class="btn btn-blue sm:w-auto">Połącz Portfel</button>
        </header>

        <!-- Główny Interfejs Aplikacji -->
        <main id="dappInterface" class="hidden">

            <!-- Pulpit -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-400">Twoje Saldo Rcoin</h3>
                    <p id="rcoinBalance" class="text-2xl font-semibold text-white mt-1">...</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-400">Twoje Saldo USDC</h3>
                    <p id="usdcBalance" class="text-2xl font-semibold text-white mt-1">...</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-400">Kurs Rcoin</h3>
                    <p id="exchangeRate" class="text-2xl font-semibold text-white mt-1">...</p>
                </div>
            </section>

            <!-- Akcje Klienta -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gray-800 p-8 rounded-xl">
                    <h2 class="text-2xl font-bold mb-6 text-white">Wpłata USDC</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="depositAmount" class="block text-sm font-medium text-gray-400">Kwota</label>
                            <input type="number" id="depositAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500 sm:text-lg p-3">
                        </div>
                        <div class="flex space-x-4">
                            <button id="approveButton" class="btn btn-blue">1. Zatwierdź</button>
                            <button id="depositButton" class="btn btn-blue">2. Wpłać</button>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-8 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-white">Wypłata</h2>
                    <div class="flex border-b border-gray-700 mb-6">
                        <button id="tabInstant" class="tab-active flex-1 py-2 text-center font-semibold transition-colors duration-300 rounded-t-md">Natychmiastowa</button>
                        <button id="tabDelayed" class="tab-inactive flex-1 py-2 text-center font-semibold transition-colors duration-300 rounded-t-md">Opóźniona</button>
                    </div>

                    <!-- Panel Wypłaty Natychmiastowej -->
                    <div id="instantWithdrawPanel">
                        <p class="text-sm text-gray-400 mb-4">Wypłać natychmiastowo z opłatą <span id="feelnfo">...</span>%.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="instantWithdrawAmount" class="block text-sm font-medium text-gray-400">Kwota USDC do wypłaty</label>
                                <input type="number" id="instantWithdrawAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500 sm:text-lg p-3">
                            </div>
                            <button id="instantWithdrawButton" class="btn btn-red">Wypłać Natychmiast</button>
                        </div>
                    </div>

                    <!-- Panel Wypłaty Opóźnionej -->
                    <div id="delayedWithdrawPanel" class="hidden">
                        <div id="requestSection">
                            <p class="text-sm text-gray-400 mb-4">Złóż wniosek o wypłatę bez opłat. Środki będą dostępne po <span id="delayInfo">...</span>.</p>
                            <div>
                                <label for="delayedWithdrawAmount" class="block text-sm font-medium text-gray-400">Kwota USDC do wypłaty</label>
                                <input type="number" id="delayedWithdrawAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500 sm:text-lg p-3">
                            </div>
                            <button id="requestDelayedWithdrawButton" class="mt-4 btn btn-blue">Złóż Wniosek</button>
                        </div>

                        <div id="manageSection" class="hidden text-center">
                            <p class="text-lg text-gray-300 mb-2">Masz aktywny wniosek o wypłatę:</p>
                            <p class="text-3xl font-bold text-white mb-4"><span id="pendingAmount">0.00</span> USDC</p>
                            <p id="unlockTime" class="font-semibold mb-6">...</p>
                            <div class="space-y-3">
                                <button id="fulfillDelayedWithdrawButton" disabled class="btn btn-blue disabled:bg-gray-500 disabled:cursor-not-allowed">Odbierz Środki</button>
                                <button id="cancelDelayedWithdrawButton" class="btn btn-blue">Anuluj Wniosek</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Panel Menedżera Funduszu -->
            <section id="fundManagerSection" class="mt-8 bg-gray-800/50 border border-blue-500/30 p-8 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-6 text-blue-300">Panel Menedżera Funduszu</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-gray-400">Wartość Funduszu (TVL)</h3>
                        <p id="tvl" class="text-2xl font-semibold text-white mt-1">...</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-gray-400">Saldo Off-Chain</h3>
                        <p id="offChainBalanceDisplay" class="text-2xl font-semibold text-white mt-1">...</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <div class="space-y-4">
                        <label for="transferToManagerAmount" class="block text-sm font-medium text-gray-400">Transferuj do zarządzania (off-chain)</label>
                        <input type="number" id="transferToManagerAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white p-3">
                        <button id="transferToManagerButton" class="btn btn-blue">Transferuj USDC</button>
                    </div>
                    <div class="space-y-4">
                        <label for="transferToVaultAmount" class="block text-sm font-medium text-gray-400">Zwróć środki do skarbca</label>
                        <input type="number" id="transferToVaultAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white p-3">
                        <button id="transferToVaultButton" class="btn btn-blue">Zwróć USDC</button>
                    </div>
                    <div class="space-y-4">
                        <label for="offChainValueAmount" class="block text-sm font-medium text-gray-400">Zaktualizuj wartość aktywów off-chain</label>
                        <input type="number" id="offChainValueAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white p-3">
                        <button id="updateOffChainValueButton" class="btn btn-blue">Aktualizuj Wartość</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4 text-white">Aktywne Wnioski o Wypłatę (ostatnie 60 dni)</h3>
                    <div class="bg-gray-800 p-4 rounded-lg max-h-60 overflow-y-auto">
                        <ul id="pendingRequestsList" class="space-y-3">
                            <!-- JS będzie wstrzykiwać wnioski tutaj -->
                        </ul>
                    </div>
                </div>
            </section>

        </main>

        <!-- Komunikat o statusie -->
        <div id="statusMessage" class="fixed bottom-5 right-5 bg-gray-800 border-l-4 p-4 rounded-lg shadow-lg max-w-sm hidden">
            <div class="flex items-center">
                <div id="statusSpinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-3"></div>
                <p id="statusText" class="text-white"></p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dApp = {
                // --- KONFIGURACJA ---
                config: {
                    vaultContractAddress: "0xfe203ef73b69c819796C3a3572609C29Dd0FaFFE",
                    usdcContractAddress: "0x41E94Eb019C0762f9Bfcf9Fb1E58725BfB0e7582",
                    desiredChainId: 80002, // Polygon Amoy
                    desiredChainHex: '0x13882',
                    vaultABI: [{"inputs":[{"internalType":"address","name":"fundManager_","type":"address"},{"internalType":"address","name":"feeRecipient_","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"ERC4626ExceededMaxTotalAssets","type":"error"},{"inputs":[],"name":"ERC4626InvalidReceiver","type":"error"},{"inputs":[],"name":"ERC4626InvalidSender","type":"error"},{"inputs":[],"name":"ERC4626InvalidShares","type":"error"},{"inputs":[],"name":"ERC4626ZeroAssets","type":"error"},{"inputs":[],"name":"ERC4626ZeroShares","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"AssetsTransferredToManager","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"AssetsTransferredToVault","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsToRedeem","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"unlockTime","type":"uint256"}],"name":"DelayedWithdrawalRequested","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"caller","type":"address"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"assets","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shares","type":"uint256"}],"name":"Deposit","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"DelayedWithdrawalCanceled","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newTotalValue","type":"uint256"}],"name":"OffChainAssetValueUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsToRedeem","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"fee","type":"uint256"}],"name":"InstantWithdrawalMade","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsClaimed","type":"uint256"}],"name":"DelayedWithdrawalClaimed","type":"event"}],
                    usdcABI: [{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"}]
                },

                // --- STAN APLIKACJI ---
                state: {
                    pendingRequests: []
                },
                provider: null,
                signer: null,
                userAddress: null,
                fundManagerAddress: null,
                contracts: { vault: null, usdc: null },

                // --- ELEMENTY DOM
                elements: {},

                // --- INICJALIZACJA ---
                async init() {
                    const ids = ["connectButton", "dappInterface", "rcoinBalance", "usdcBalance", "exchangeRate", "tvl", "approveButton", "depositButton", "depositAmount", "instantWithdrawAmount", "instantWithdrawButton", "delayedWithdrawAmount", "requestDelayedWithdrawButton", "fulfillDelayedWithdrawButton", "cancelDelayedWithdrawButton", "tabInstant", "tabDelayed", "instantWithdrawPanel", "delayedWithdrawPanel", "requestSection", "manageSection", "pendingAmount", "unlockTime", "feeInfo", "delayInfo", "fundManagerSection", "transferToManagerAmount", "transferToManagerButton", "transferToVaultAmount", "transferToVaultButton", "offChainValueAmount", "updateOffChainValueButton", "statusMessage", "statusText", "statusSpinner", "offChainBalanceDisplay", "pendingRequestsList"];
                    ids.forEach(id => this.elements[id] = document.getElementById(id));

                    this.setupEventListeners();

                    if (window.ethereum && window.ethereum.selectedAddress) {
                        this.connectWallet();
                    }
                },

                // --- NASŁUCHIWANIE ZDARZEŃ
                setupEventListeners() {
                    this.elements.connectButton.addEventListener('click', () => this.connectWallet());
                    this.elements.approveButton.addEventListener('click', () => this.handleApprove());
                    this.elements.depositButton.addEventListener('click', () => this.handleDeposit());
                    this.elements.instantWithdrawButton.addEventListener('click', () => this.handleInstantWithdraw());
                    this.elements.requestDelayedWithdrawButton.addEventListener('click', () => this.handleRequestDelayedWithdraw());
                    this.elements.fulfillDelayedWithdrawButton.addEventListener('click', () => this.handleFulfillDelayedWithdraw());
                    this.elements.cancelDelayedWithdrawButton.addEventListener('click', () => this.handleCancelDelayedWithdraw());
                    this.elements.tabInstant.addEventListener('click', () => this.switchTab('instant'));
                    this.elements.tabDelayed.addEventListener('click', () => this.switchTab('delayed'));
                    this.elements.transferToManagerButton.addEventListener('click', () => this.handleTransferToManager());
                    this.elements.transferToVaultButton.addEventListener('click', () => this.handleTransferToVault());
                    this.elements.updateOffChainValueButton.addEventListener('click', () => this.handleUpdateOffChainValue());

                    if (window.ethereum) {
                        window.ethereum.on('accountsChanged', (accounts) => this.handleAccountsChanged(accounts));
                        window.ethereum.on('chainChanged', () => window.location.reload());
                    }
                },

                // --- LOGIKA PORTFELA I KONTRAKTÓW
                async connectWallet() {
                    if (!window.ethereum) {
                        return this.showStatus("Zainstaluj MetaMask!", "error");
                    }
                    try {
                        await this.checkNetwork();
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        this.handleAccountsChanged(accounts);
                    } catch (error) {
                        console.error("Błąd połączenia z portfelem:", error);
                        this.showStatus("Błąd połączenia z portfelem", "error");
                    }
                },

                async checkNetwork() {
                    const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                    if (currentChainId !== this.config.desiredChainHex) {
                        this.showStatus("Proszę przełączyć na sieć Polygon Amoy", "info");
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: this.config.desiredChainHex }],
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                this.showStatus("Dodaj sieć Polygon Amoy do MetaMask", "error");
                            } else {
                                throw switchError;
                            }
                        }
                    }
                },

                async handleAccountsChanged(accounts) {
                    if (accounts.length === 0) {
                        this.state.userAddress = null;
                        this.elements.dappInterface.classList.add('hidden');
                        this.elements.connectButton.innerText = "Połącz Portfel";
                        console.log("Proszę połączyć się z MetaMask.");
                    } else {
                        this.state.userAddress = accounts[0];
                        this.elements.connectButton.innerText = `${this.state.userAddress.substring(0, 6)}...${this.state.userAddress.substring(38)}`;
                        this.elements.dappInterface.classList.remove('hidden');
                        await this.initializeContracts();
                        await this.startApp();
                    }
                },

                async initializeContracts() {
                    this.state.provider = new ethers.providers.Web3Provider(window.ethereum);
                    this.state.signer = this.state.provider.getSigner();
                    this.contracts.vault = new ethers.Contract(this.config.vaultContractAddress, this.config.vaultABI, this.state.signer);
                    this.contracts.usdc = new ethers.Contract(this.config.usdcContractAddress, this.config.usdcABI, this.state.signer);
                    this.state.fundManagerAddress = await this.contracts.vault.fundManager();
                },

                // --- LOGIKA APLIKACJI ---
                async startApp() {
                    this.updateView();
                    // Ustawienie interwałów dla odświeżania danych
                    setInterval(() => this.updateView(), 5000);
                },

                async updateView() {
                    if (!this.state.userAddress) return;

                    try {
                        // Aktualizacja sald i kursu
                        const [usdcBalance, rcoinBalance, totalAssets, exchangeRate] = await Promise.all([
                            this.contracts.usdc.balanceOf(this.state.userAddress),
                            this.contracts.vault.balanceOf(this.state.userAddress),
                            this.contracts.vault.totalAssets(),
                            this.contracts.vault.getExchangeRate()
                        ]);

                        const usdcBalanceFormatted = ethers.utils.formatUnits(usdcBalance, 6);
                        const rcoinBalanceFormatted = ethers.utils.formatUnits(rcoinBalance, 6);
                        const exchangeRateFormatted = parseFloat(ethers.utils.formatUnits(exchangeRate, 6)).toFixed(2);
                        
                        this.elements.rcoinBalance.innerText = `${parseFloat(rcoinBalanceFormatted).toFixed(2)} Rcoin`;
                        this.elements.usdcBalance.innerText = `${parseFloat(usdcBalanceFormatted).toFixed(2)} USDC`;
                        this.elements.exchangeRate.innerText = `${exchangeRateFormatted} USDC/Rcoin`;

                        const fee = await this.contracts.vault.instantWithdrawalFee();
                        this.elements.feeInfo.innerText = ethers.utils.formatUnits(fee, 0);

                        const delayedWithdrawalPeriod = await this.contracts.vault.delayedWithdrawalPeriod();
                        this.elements.delayInfo.innerText = this.formatTime(delayedWithdrawalPeriod.toNumber());

                        // Sprawdzenie, czy użytkownik jest menedżerem funduszu
                        if (this.state.userAddress.toLowerCase() === this.state.fundManagerAddress.toLowerCase()) {
                            this.elements.fundManagerSection.classList.remove('hidden');
                            const [tvl, offChainBalance] = await Promise.all([
                                this.contracts.vault.totalAssets(),
                                this.contracts.vault.offChainBalance()
                            ]);
                            this.elements.tvl.innerText = `${parseFloat(ethers.utils.formatUnits(tvl, 6)).toFixed(2)} USDC`;
                            this.elements.offChainBalanceDisplay.innerText = `${parseFloat(ethers.utils.formatUnits(offChainBalance, 6)).toFixed(2)} USDC`;
                        } else {
                            this.elements.fundManagerSection.classList.add('hidden');
                        }

                        // Aktualizacja widoku dla wypłaty opóźnionej
                        const pendingRequest = await this.contracts.vault.getDelayedWithdrawalRequest(this.state.userAddress);
                        if (pendingRequest.assetsToRedeem.isZero()) {
                            this.elements.requestSection.classList.remove('hidden');
                            this.elements.manageSection.classList.add('hidden');
                        } else {
                            this.elements.requestSection.classList.add('hidden');
                            this.elements.manageSection.classList.remove('hidden');
                            this.elements.pendingAmount.innerText = parseFloat(ethers.utils.formatUnits(pendingRequest.assetsToRedeem, 6)).toFixed(2);
                            const currentTime = Math.floor(Date.now() / 1000);
                            const unlockTime = pendingRequest.unlockTime.toNumber();
                            if (currentTime >= unlockTime) {
                                this.elements.unlockTime.innerText = "Dostępne do odebrania!";
                                this.elements.fulfillDelayedWithdrawButton.disabled = false;
                                this.elements.fulfillDelayedWithdrawButton.classList.remove('disabled:bg-gray-500');
                                this.elements.fulfillDelayedWithdrawButton.classList.add('btn-blue');
                            } else {
                                const remainingTime = unlockTime - currentTime;
                                this.elements.unlockTime.innerText = `Dostępne za: ${this.formatTime(remainingTime)}`;
                                this.elements.fulfillDelayedWithdrawButton.disabled = true;
                                this.elements.fulfillDelayedWithdrawButton.classList.add('disabled:bg-gray-500');
                                this.elements.fulfillDelayedWithdrawButton.classList.remove('btn-blue');
                            }
                        }

                        // Aktualizacja listy wniosków dla menedżera
                        if (this.state.userAddress.toLowerCase() === this.state.fundManagerAddress.toLowerCase()) {
                            await this.updatePendingRequestsList();
                        }

                    } catch (error) {
                        console.error("Błąd aktualizacji widoku:", error);
                        this.showStatus("Błąd aktualizacji danych", "error");
                    }
                },

                async updatePendingRequestsList() {
                    const listElement = this.elements.pendingRequestsList;
                    listElement.innerHTML = '';
                    const vaultEvents = await this.contracts.vault.queryFilter("DelayedWithdrawalRequested");
                    const now = Math.floor(Date.now() / 1000);
                    
                    vaultEvents.reverse().forEach(event => {
                        const { user, assetsToRedeem, unlockTime } = event.args;
                        const isExpired = now >= unlockTime.toNumber();
                        const timeString = this.formatTime(Math.max(0, unlockTime.toNumber() - now));
                        const listItem = document.createElement('li');
                        const statusClass = isExpired ? 'bg-green-700/30 border-green-500' : 'bg-blue-700/30 border-blue-500';

                        listItem.className = `p-4 rounded-lg border-l-4 ${statusClass} flex justify-between items-center`;
                        listItem.innerHTML = `
                            <div>
                                <p class="text-sm font-semibold">${user.substring(0, 6)}...${user.substring(38)}</p>
                                <p class="text-sm font-medium">${parseFloat(ethers.utils.formatUnits(assetsToRedeem, 6)).toFixed(2)} USDC</p>
                            </div>
                            <span class="text-xs text-gray-400">${isExpired ? 'Wniosek gotowy' : `Dostępne za: ${timeString}`}</span>
                        `;
                        listElement.appendChild(listItem);
                    });
                },

                // --- FUNKCJE POMOCNICZE ---

                formatTime(seconds) {
                    if (seconds <= 0) return "0s";
                    const d = Math.floor(seconds / (3600 * 24));
                    const h = Math.floor((seconds % (3600 * 24)) / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = seconds % 60;
                    
                    let parts = [];
                    if (d > 0) parts.push(`${d}d`);
                    if (h > 0) parts.push(`${h}h`);
                    if (m > 0) parts.push(`${m}m`);
                    if (s > 0 && parts.length < 3) parts.push(`${s}s`);
                    
                    return parts.join(' ');
                },

                showStatus(message, type = "info", autoHide = false) {
                    this.elements.statusText.innerText = message;
                    const statusDiv = this.elements.statusMessage;
                    const spinner = this.elements.statusSpinner;

                    statusDiv.classList.remove('hidden', 'bg-red-900', 'bg-green-900', 'bg-blue-900', 'border-red-500', 'border-green-500', 'border-blue-500', 'animate-pulse');
                    spinner.classList.add('hidden');

                    if (type === 'loading') {
                        statusDiv.classList.add('bg-blue-900', 'border-blue-500', 'animate-pulse');
                        spinner.classList.remove('hidden');
                    } else if (type === 'success') {
                        statusDiv.classList.add('bg-green-900', 'border-green-500');
                    } else if (type === 'error') {
                        statusDiv.classList.add('bg-red-900', 'border-red-500');
                    } else { // info
                        statusDiv.classList.add('bg-gray-800', 'border-gray-500');
                    }
                    
                    statusDiv.classList.remove('hidden');
                    if (autoHide) {
                        setTimeout(() => statusDiv.classList.add('hidden'), 5000);
                    }
                },

                // --- OBSŁUGA ZDARZEŃ UŻYTKOWNIKA ---

                async handleApprove() {
                    this.showStatus("Zatwierdzanie...", "loading");
                    try {
                        const amount = ethers.utils.parseUnits(this.elements.depositAmount.value, 6);
                        const tx = await this.contracts.usdc.approve(this.config.vaultContractAddress, amount);
                        await tx.wait();
                        this.showStatus("Zatwierdzono pomyślnie!", "success", true);
                    } catch (error) {
                        console.error("Błąd zatwierdzania:", error);
                        this.showStatus("Błąd zatwierdzania", "error", true);
                    }
                },

                async handleDeposit() {
                    this.showStatus("Wpłacanie...", "loading");
                    try {
                        const amount = ethers.utils.parseUnits(this.elements.depositAmount.value, 6);
                        const tx = await this.contracts.vault.deposit(amount, this.state.userAddress);
                        await tx.wait();
                        this.showStatus("Wpłacono pomyślnie!", "success", true);
                    } catch (error) {
                        console.error("Błąd wpłaty:", error);
                        this.showStatus("Błąd wpłaty", "error", true);
                    }
                },

                async handleInstantWithdraw() {
                    this.showStatus("Wypłacanie natychmiastowo...", "loading");
                    try {
                        const amount = ethers.utils.parseUnits(this.elements.instantWithdrawAmount.value, 6);
                        const tx = await this.contracts.vault.instantWithdraw(amount, this.state.userAddress);
                        await tx.wait();
                        this.showStatus("Wypłacono natychmiastowo!", "success", true);
                    } catch (error) {
                        console.error("Błąd wypłaty natychmiastowej:", error);
                        this.showStatus("Błąd wypłaty natychmiastowej", "error", true);
                    }
                },

                async handleRequestDelayedWithdraw() {
                    this.showStatus("Składanie wniosku...", "loading");
                    try {
                        const amount = ethers.utils.parseUnits(this.elements.delayedWithdrawAmount.value, 6);
                        const tx = await this.contracts.vault.requestDelayedWithdrawal(amount);
                        await tx.wait();
                        this.showStatus("Wniosek złożono pomyślnie!", "success", true);
                    } catch (error) {
                        console.error("Błąd składania wniosku:", error);
                        this.showStatus("Błąd składania wniosku", "error", true);
                    }
                },

                async handleFulfillDelayedWithdraw() {
                    this.showStatus("Odbieranie środków...", "loading");
                    try {
                        const tx = await this.contracts.vault.fulfillDelayedWithdrawal();
                        await tx.wait();
                        this.showStatus("Środki odebrane pomyślnie!", "success", true);
                    } catch (error) {
                        console.error("Błąd odbioru środków:", error);
                        this.showStatus("Błąd odbioru środków", "error", true);
                    }
                },

                async handleCancelDelayedWithdraw() {
                    this.showStatus("Anulowanie wniosku...", "loading");
                    try {
                        const tx = await this.contracts.vault.cancelDelayedWithdrawal();
                        await tx.wait();
                        this.showStatus("Wniosek anulowano pomyślnie!", "success", true);
                    } catch (error) {
                        console.error("Błąd anulowania wniosku:", error);
                        this.showStatus("Błąd anulowania wniosku", "error", true);
                    }
                },

                async handleTransferToManager() {
                    this.showStatus("Transferowanie...", "loading");
                    try {
                        const amount = ethers.utils.parseUnits(this.elements.transferToManagerAmount.value, 6);
                        const tx = await this.contracts.vault.transferAssetsToManager(amount);
                        await tx.wait();
                        this.showStatus("Transfer do menedżera pomyślny!", "success", true);
                    } catch (error) {
                        console.error("Błąd transferu do menedżera:", error);
                        this.showStatus("Błąd transferu do menedżera", "error", true);
                    }
                },

                async handleTransferToVault() {
                    this.showStatus("Zwracanie...", "loading");
                    try {
                        const amount = ethers.utils.parseUnits(this.elements.transferToVaultAmount.value, 6);
                        const tx = await this.contracts.vault.transferAssetsToVault(amount);
                        await tx.wait();
                        this.showStatus("Zwrócono środki do skarbca!", "success", true);
                    } catch (error) {
                        console.error("Błąd zwrotu środków:", error);
                        this.showStatus("Błąd zwrotu środków", "error", true);
                    }
                },
                
                async handleUpdateOffChainValue() {
                    this.showStatus("Aktualizowanie...", "loading");
                    try {
                        const amount = ethers.utils.parseUnits(this.elements.offChainValueAmount.value, 6);
                        const tx = await this.contracts.vault.updateOffChainAssetValue(amount);
                        await tx.wait();
                        this.showStatus("Wartość off-chain zaktualizowana!", "success", true);
                    } catch (error) {
                        console.error("Błąd aktualizacji wartości off-chain:", error);
                        this.showStatus("Błąd aktualizacji wartości off-chain", "error", true);
                    }
                },

                // --- FUNKCJE OBSŁUGI ZAKŁADEK ---
                switchTab(tabName) {
                    if (tabName === 'instant') {
                        this.elements.tabInstant.classList.replace('tab-inactive', 'tab-active');
                        this.elements.tabDelayed.classList.replace('tab-active', 'tab-inactive');
                        this.elements.instantWithdrawPanel.classList.remove('hidden');
                        this.elements.delayedWithdrawPanel.classList.add('hidden');
                    } else {
                        this.elements.tabInstant.classList.replace('tab-active', 'tab-inactive');
                        this.elements.tabDelayed.classList.replace('tab-inactive', 'tab-active');
                        this.elements.instantWithdrawPanel.classList.add('hidden');
                        this.elements.delayedWithdrawPanel.classList.remove('hidden');
                    }
                }
            };
            dApp.init();
        });
    </script>

</body>
</html>

