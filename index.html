<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rcoin Fund dApp v4.7 (Poprawiony)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        .tab-inactive {
            background-color: #374151;
            color: #d1d5db;
        }
        .loader {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">
    <div id="statusMessage" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg max-w-sm hidden border-l-4">
        <div class="flex items-center">
            <div id="statusSpinner" class="loader ease-linear rounded-full border-4 h-6 w-6 mr-4"></div>
            <div id="statusText" class="flex-grow"></div>
        </div>
    </div>

    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-2xl">
        <div class="flex flex-col items-center">
            <h1 class="text-3xl font-bold text-center text-blue-400 mb-6">Rcoin Fund dApp</h1>
            <div class="w-full text-center p-4 rounded-xl border border-blue-600 bg-blue-900 bg-opacity-30 mb-6">
                <p class="text-sm text-gray-400">Połączono z <span id="userAddress"></span></p>
                <p class="text-xl mt-2 font-bold">Twoje Saldo Rcoin: <span id="rcoinBalance">0</span></p>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mb-6 text-center">
            <div class="bg-gray-700 p-4 rounded-xl">
                <p class="text-sm font-semibold">Całkowite Aktywa Skarbca</p>
                <p class="text-lg text-green-400 mt-1"><span id="totalAssets">0</span> USDC</p>
            </div>
            <div class="bg-gray-700 p-4 rounded-xl">
                <p class="text-sm font-semibold">Kurs Wymiany Rcoin</p>
                <p class="text-lg text-yellow-400 mt-1">1 Rcoin ≈ <span id="exchangeRate">0</span> USDC</p>
            </div>
        </div>

        <div class="bg-gray-700 p-4 rounded-xl mb-6">
            <h3 class="text-lg font-bold mb-2">Stan Skarbca</h3>
            <div class="space-y-2 text-sm text-gray-300">
                <p>Off-Chain Balance: <span id="offChainBalance">0</span> USDC</p>
                <p>On-Chain Balance: <span id="onChainBalance">0</span> USDC</p>
                <p>Całkowita Podaż Rcoin: <span id="rcoinTotalSupply">0</span></p>
                <p>Opóźnienie Wypłaty: <span id="withdrawalDelay">0</span> dni</p>
                <p>Opłata za Natychmiastową Wypłatę: <span id="instantFee">0</span>%</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2 text-center mb-6">
            <button id="tabDeposit" class="py-3 rounded-lg font-semibold transition-colors tab-active">Wpłata</button>
            <button id="tabWithdrawal" class="py-3 rounded-lg font-semibold transition-colors tab-inactive">Wypłata</button>
        </div>

        <div id="panelDeposit" class="bg-gray-700 p-6 rounded-xl">
            <h3 class="text-xl font-semibold mb-4">Wpłata USDC</h3>
            <p class="text-sm text-gray-400 mb-4">Wpłać USDC do funduszu i odbierz tokeny Rcoin.</p>
            <div class="relative mb-4">
                <input type="number" id="depositAmount" placeholder="0.00" class="w-full p-3 rounded-lg bg-gray-600 text-gray-200 border border-gray-500 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">USDC</span>
            </div>
            <button id="btnDeposit" class="w-full py-3 rounded-lg font-bold transition-colors bg-blue-600 hover:bg-blue-700 active:scale-98 text-white">Wpłać</button>
        </div>

        <div id="panelWithdrawal" class="hidden bg-gray-700 p-6 rounded-xl">
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="tabInstant" class="py-2 px-4 rounded-lg font-semibold transition-colors tab-active">Natychmiastowa</button>
                <button id="tabDelayed" class="py-2 px-4 rounded-lg font-semibold transition-colors tab-inactive">Opóźniona</button>
            </div>

            <div id="instantWithdrawPanel">
                <h3 class="text-xl font-semibold mb-4">Natychmiastowa Wypłata</h3>
                <p class="text-sm text-gray-400 mb-4">Wypłać natychmiast, płacąc opłatę. Opłata: <span id="instantFeePanel">0</span>%.</p>
                <div class="relative mb-4">
                    <input type="number" id="instantWithdrawalAmount" placeholder="0.00" class="w-full p-3 rounded-lg bg-gray-600 text-gray-200 border border-gray-500 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">USDC</span>
                </div>
                <button id="btnInstantWithdrawal" class="w-full py-3 rounded-lg font-bold transition-colors bg-blue-600 hover:bg-blue-700 active:scale-98 text-white">Wypłać Natychmiast</button>
            </div>

            <div id="delayedWithdrawPanel" class="hidden">
                <h3 class="text-xl font-semibold mb-4">Opóźniona Wypłata</h3>
                <p class="text-sm text-gray-400 mb-4">Poproś o wypłatę bez opłat. Wypłata dostępna po <span id="delayedWithdrawalPeriod">0</span> dniach.</p>
                <div class="relative mb-4">
                    <input type="number" id="delayedWithdrawalAmount" placeholder="0.00" class="w-full p-3 rounded-lg bg-gray-600 text-gray-200 border border-gray-500 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">USDC</span>
                </div>
                <div id="delayedRequestStatus" class="bg-gray-800 p-3 rounded-lg text-sm hidden">
                    <p>Oczekujący wniosek na: <span id="delayedRequestAssets">0</span> USDC</p>
                    <p>Dostępne do odbioru: <span id="delayedRequestUnlockTime"></span></p>
                </div>
                <button id="btnRequestDelayedWithdrawal" class="w-full py-3 rounded-lg font-bold transition-colors bg-blue-600 hover:bg-blue-700 active:scale-98 text-white mt-4">Poproś o Wypłatę</button>
                <button id="btnFulfillDelayedWithdrawal" class="w-full py-3 rounded-lg font-bold transition-colors bg-green-600 hover:bg-green-700 active:scale-98 text-white mt-2 hidden">Odbierz Wypłatę</button>
                <button id="btnCancelDelayedWithdrawal" class="w-full py-3 rounded-lg font-bold transition-colors bg-red-600 hover:bg-red-700 active:scale-98 text-white mt-2 hidden">Anuluj Wniosek</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-2 mt-6">
            <button id="btnTransferToManager" class="w-full py-3 px-4 rounded-lg font-bold transition-colors bg-purple-600 hover:bg-purple-700 active:scale-98 text-white hidden">Prześlij do Managera</button>
            <button id="btnTransferToVault" class="w-full py-3 px-4 rounded-lg font-bold transition-colors bg-purple-600 hover:bg-purple-700 active:scale-98 text-white hidden">Zwróć do Skarbca</button>
            <button id="btnUpdateOffChain" class="w-full py-3 px-4 rounded-lg font-bold transition-colors bg-purple-600 hover:bg-purple-700 active:scale-98 text-white hidden">Aktualizuj Off-Chain</button>
        </div>
    </div>

    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js";
        const vaultAddress = "0xfe203ef73b69c819796C3a3572609C29Dd0FaFFE"; // Zmień na adres wdrożonego kontraktu
        const USDC_ADDRESS = "0x41E94Eb019C0762f9Bfcf9Fb1E58725BfB0e7582";
        const vaultABI = [
            "function deposit(uint256 assets, address receiver) external returns (uint256 shares)",
            "function instantWithdrawal(uint256 assetsToRedeem) external",
            "function requestDelayedWithdrawal(uint256 assetsToRedeem) external",
            "function fulfillDelayedWithdrawal(address client) external",
            "function cancelDelayedWithdrawal() external",
            "function asset() public view returns (address)",
            "function totalAssets() public view returns (uint256)",
            "function totalSupply() public view returns (uint256)",
            "function balanceOf(address account) public view returns (uint256)",
            "function getExchangeRate() public view returns (uint256)",
            "function getOffChainBalance() public view returns (uint256)",
            "function getDelayedWithdrawalRequest(address user) public view returns (uint256 assetsToRedeem, uint256 unlockTime)",
            "function instantWithdrawalFeeBps() public view returns (uint16)",
            "function withdrawalDelayPeriod() public view returns (uint256)",
            "function transferAssetsToFundManager(uint256 assetsToTransfer) external",
            "function transferAssetsToVault(uint256 assetsToTransfer) external",
            "function updateOffChainAssetValue(uint256 newTotalValue) external",
            "function fundManager() public view returns (address)"
        ];

        const usdcABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function balanceOf(address account) external view returns (uint256)"
        ];

        const elements = {
            userAddress: document.getElementById('userAddress'),
            rcoinBalance: document.getElementById('rcoinBalance'),
            totalAssets: document.getElementById('totalAssets'),
            exchangeRate: document.getElementById('exchangeRate'),
            offChainBalance: document.getElementById('offChainBalance'),
            onChainBalance: document.getElementById('onChainBalance'),
            rcoinTotalSupply: document.getElementById('rcoinTotalSupply'),
            withdrawalDelay: document.getElementById('withdrawalDelay'),
            instantFee: document.getElementById('instantFee'),
            instantFeePanel: document.getElementById('instantFeePanel'),
            tabDeposit: document.getElementById('tabDeposit'),
            tabWithdrawal: document.getElementById('tabWithdrawal'),
            tabInstant: document.getElementById('tabInstant'),
            tabDelayed: document.getElementById('tabDelayed'),
            panelDeposit: document.getElementById('panelDeposit'),
            panelWithdrawal: document.getElementById('panelWithdrawal'),
            instantWithdrawPanel: document.getElementById('instantWithdrawPanel'),
            delayedWithdrawPanel: document.getElementById('delayedWithdrawPanel'),
            depositAmount: document.getElementById('depositAmount'),
            btnDeposit: document.getElementById('btnDeposit'),
            instantWithdrawalAmount: document.getElementById('instantWithdrawalAmount'),
            btnInstantWithdrawal: document.getElementById('btnInstantWithdrawal'),
            delayedWithdrawalAmount: document.getElementById('delayedWithdrawalAmount'),
            delayedRequestStatus: document.getElementById('delayedRequestStatus'),
            delayedRequestAssets: document.getElementById('delayedRequestAssets'),
            delayedRequestUnlockTime: document.getElementById('delayedRequestUnlockTime'),
            btnRequestDelayedWithdrawal: document.getElementById('btnRequestDelayedWithdrawal'),
            btnFulfillDelayedWithdrawal: document.getElementById('btnFulfillDelayedWithdrawal'),
            btnCancelDelayedWithdrawal: document.getElementById('btnCancelDelayedWithdrawal'),
            statusMessage: document.getElementById('statusMessage'),
            statusText: document.getElementById('statusText'),
            statusSpinner: document.getElementById('statusSpinner'),
            btnTransferToManager: document.getElementById('btnTransferToManager'),
            btnTransferToVault: document.getElementById('btnTransferToVault'),
            btnUpdateOffChain: document.getElementById('btnUpdateOffChain'),
        };

        let provider;
        let signer;
        let vaultContract;
        let usdcContract;
        let userAddress;
        let fundManagerAddress;

        // Inicjalizacja i połączenie z portfelem
        async function connect() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    elements.userAddress.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                    vaultContract = new ethers.Contract(vaultAddress, vaultABI, signer);
                    usdcContract = new ethers.Contract(USDC_ADDRESS, usdcABI, signer);
                    fundManagerAddress = await vaultContract.fundManager();
                    updateUIForFundManager();
                    updateWalletStatus();
                } catch (error) {
                    showStatus(`Błąd połączenia z portfelem: ${error.message}`, true, true);
                }
            } else {
                showStatus("Proszę zainstalować MetaMask!", true, true);
            }
        }

        // --- Funkcje aktualizacji UI ---
        async function updateWalletStatus() {
            try {
                // Pokaż, że dane są ładowane
                showStatus("Ładowanie danych...", false, false);
                const rcoinBalance = ethers.utils.formatUnits(await vaultContract.balanceOf(userAddress), 18);
                const totalAssets = ethers.utils.formatUnits(await vaultContract.totalAssets(), 6);
                const rcoinTotalSupply = ethers.utils.formatUnits(await vaultContract.totalSupply(), 18);
                const offChainBalance = ethers.utils.formatUnits(await vaultContract.getOffChainBalance(), 6);
                const onChainBalance = ethers.utils.formatUnits(await usdcContract.balanceOf(vaultAddress), 6);
                const exchangeRate = ethers.utils.formatUnits(await vaultContract.getExchangeRate(), 18);
                const instantFeeBps = await vaultContract.instantWithdrawalFeeBps();
                const withdrawalDelay = await vaultContract.withdrawalDelayPeriod();
                const [delayedAssets, unlockTime] = await vaultContract.getDelayedWithdrawalRequest(userAddress);

                elements.rcoinBalance.textContent = parseFloat(rcoinBalance).toFixed(2);
                elements.totalAssets.textContent = parseFloat(totalAssets).toFixed(2);
                elements.exchangeRate.textContent = parseFloat(exchangeRate).toFixed(6);
                elements.offChainBalance.textContent = parseFloat(offChainBalance).toFixed(2);
                elements.onChainBalance.textContent = parseFloat(onChainBalance).toFixed(2);
                elements.rcoinTotalSupply.textContent = parseFloat(rcoinTotalSupply).toFixed(2);
                elements.withdrawalDelay.textContent = Math.floor(withdrawalDelay / 86400); // Konwersja sekund na dni
                elements.instantFee.textContent = instantFeeBps / 100;
                elements.instantFeePanel.textContent = instantFeeBps / 100;
                elements.delayedWithdrawalPeriod.textContent = Math.floor(withdrawalDelay / 86400);

                if (delayedAssets > 0) {
                    elements.delayedRequestStatus.classList.remove('hidden');
                    elements.delayedRequestAssets.textContent = ethers.utils.formatUnits(delayedAssets, 6);
                    const unlockDate = new Date(unlockTime.toNumber() * 1000);
                    elements.delayedRequestUnlockTime.textContent = unlockDate.toLocaleString();
                    const currentTime = Math.floor(Date.now() / 1000);
                    if (currentTime >= unlockTime.toNumber()) {
                        elements.btnFulfillDelayedWithdrawal.classList.remove('hidden');
                        elements.btnRequestDelayedWithdrawal.classList.add('hidden');
                        elements.btnCancelDelayedWithdrawal.classList.remove('hidden');
                    } else {
                        elements.btnFulfillDelayedWithdrawal.classList.add('hidden');
                        elements.btnRequestDelayedWithdrawal.classList.add('hidden');
                        elements.btnCancelDelayedWithdrawal.classList.remove('hidden');
                    }
                } else {
                    elements.delayedRequestStatus.classList.add('hidden');
                    elements.btnRequestDelayedWithdrawal.classList.remove('hidden');
                    elements.btnFulfillDelayedWithdrawal.classList.add('hidden');
                    elements.btnCancelDelayedWithdrawal.classList.add('hidden');
                }
                showStatus("Dane zaktualizowane.", false, true);
            } catch (error) {
                console.error("Błąd podczas aktualizacji UI:", error);
                showStatus(`Błąd podczas aktualizacji UI: ${error.message}`, true, true);
            }
        }

        function updateUIForFundManager() {
            if (userAddress.toLowerCase() === fundManagerAddress.toLowerCase()) {
                elements.btnTransferToManager.classList.remove('hidden');
                elements.btnTransferToVault.classList.remove('hidden');
                elements.btnUpdateOffChain.classList.remove('hidden');
            } else {
                elements.btnTransferToManager.classList.add('hidden');
                elements.btnTransferToVault.classList.add('hidden');
                elements.btnUpdateOffChain.classList.add('hidden');
            }
        }

        // --- Funkcje do obsługi transakcji ---
        async function handleDeposit() {
            const amount = elements.depositAmount.value;
            if (!amount || amount <= 0) {
                showStatus("Proszę podać kwotę większą niż 0.", true, true);
                return;
            }
            try {
                showStatus("Zatwierdzanie tokenów...", false, false);
                const amountInWei = ethers.utils.parseUnits(amount, 6);
                const approvalTx = await usdcContract.approve(vaultAddress, amountInWei);
                await approvalTx.wait();
                showStatus("Wpłacanie do skarbca...", false, false);
                const depositTx = await vaultContract.deposit(amountInWei, userAddress);
                await depositTx.wait();
                showStatus("Wpłata zakończona sukcesem!", false, true);
                updateWalletStatus();
            } catch (error) {
                console.error("Błąd wpłaty:", error);
                showStatus(`Błąd wpłaty: ${error.message}`, true, true);
            }
        }

        async function handleInstantWithdrawal() {
            const amount = elements.instantWithdrawalAmount.value;
            if (!amount || amount <= 0) {
                showStatus("Proszę podać kwotę większą niż 0.", true, true);
                return;
            }
            try {
                showStatus("Wypłata natychmiastowa w toku...", false, false);
                const amountInWei = ethers.utils.parseUnits(amount, 6);
                const tx = await vaultContract.instantWithdrawal(amountInWei);
                await tx.wait();
                showStatus("Wypłata zakończona sukcesem!", false, true);
                updateWalletStatus();
            } catch (error) {
                console.error("Błąd wypłaty natychmiastowej:", error);
                showStatus(`Błąd wypłaty natychmiastowej: ${error.message}`, true, true);
            }
        }

        async function handleRequestDelayedWithdrawal() {
            const amount = elements.delayedWithdrawalAmount.value;
            if (!amount || amount <= 0) {
                showStatus("Proszę podać kwotę większą niż 0.", true, true);
                return;
            }
            try {
                showStatus("Wniosek o opóźnioną wypłatę w toku...", false, false);
                const amountInWei = ethers.utils.parseUnits(amount, 6);
                const tx = await vaultContract.requestDelayedWithdrawal(amountInWei);
                await tx.wait();
                showStatus("Wniosek złożony pomyślnie!", false, true);
                updateWalletStatus();
            } catch (error) {
                console.error("Błąd wniosku o wypłatę:", error);
                showStatus(`Błąd wniosku o wypłatę: ${error.message}`, true, true);
            }
        }

        async function handleFulfillDelayedWithdrawal() {
            try {
                showStatus("Realizacja opóźnionej wypłaty...", false, false);
                const tx = await vaultContract.fulfillDelayedWithdrawal(userAddress);
                await tx.wait();
                showStatus("Wypłata zrealizowana pomyślnie!", false, true);
                updateWalletStatus();
            } catch (error) {
                console.error("Błąd realizacji wypłaty:", error);
                showStatus(`Błąd realizacji wypłaty: ${error.message}`, true, true);
            }
        }

        async function handleCancelDelayedWithdrawal() {
            try {
                showStatus("Anulowanie wniosku o wypłatę...", false, false);
                const tx = await vaultContract.cancelDelayedWithdrawal();
                await tx.wait();
                showStatus("Wniosek anulowany pomyślnie!", false, true);
                updateWalletStatus();
            } catch (error) {
                console.error("Błąd anulowania wniosku:", error);
                showStatus(`Błąd anulowania wniosku: ${error.message}`, true, true);
            }
        }

        // --- Obsługa zdarzeń UI ---
        elements.tabDeposit.addEventListener('click', () => togglePanel('deposit'));
        elements.tabWithdrawal.addEventListener('click', () => togglePanel('withdrawal'));
        elements.tabInstant.addEventListener('click', () => toggleWithdrawalPanel('instant'));
        elements.tabDelayed.addEventListener('click', () => toggleWithdrawalPanel('delayed'));
        elements.btnDeposit.addEventListener('click', handleDeposit);
        elements.btnInstantWithdrawal.addEventListener('click', handleInstantWithdrawal);
        elements.btnRequestDelayedWithdrawal.addEventListener('click', handleRequestDelayedWithdrawal);
        elements.btnFulfillDelayedWithdrawal.addEventListener('click', handleFulfillDelayedWithdrawal);
        elements.btnCancelDelayedWithdrawal.addEventListener('click', handleCancelDelayedWithdrawal);

        function togglePanel(panel) {
            if (panel === 'deposit') {
                elements.tabDeposit.classList.replace('tab-inactive', 'tab-active');
                elements.tabWithdrawal.classList.replace('tab-active', 'tab-inactive');
                elements.panelDeposit.classList.remove('hidden');
                elements.panelWithdrawal.classList.add('hidden');
            } else {
                elements.tabDeposit.classList.replace('tab-active', 'tab-inactive');
                elements.tabWithdrawal.classList.replace('tab-inactive', 'tab-active');
                elements.panelDeposit.classList.add('hidden');
                elements.panelWithdrawal.classList.remove('hidden');
            }
        }

        function toggleWithdrawalPanel(panel) {
            if (panel === 'instant') {
                elements.tabInstant.classList.replace('tab-inactive', 'tab-active');
                elements.tabDelayed.classList.replace('tab-active', 'tab-inactive');
                elements.instantWithdrawPanel.classList.remove('hidden');
                elements.delayedWithdrawalPanel.classList.add('hidden');
            } else {
                elements.tabInstant.classList.replace('tab-active', 'tab-inactive');
                elements.tabDelayed.classList.replace('tab-inactive', 'tab-active');
                elements.instantWithdrawPanel.classList.add('hidden');
                elements.delayedWithdrawalPanel.classList.remove('hidden');
            }
        }

        function showStatus(message, isError = false, autoHide = false) {
            elements.statusText.textContent = message;
            elements.statusMessage.classList.remove('hidden');
            elements.statusMessage.classList.remove('border-red-500', 'border-green-500', 'border-blue-500');
            elements.statusSpinner.classList.remove('hidden');
            elements.statusMessage.classList.add('animate-pulse');

            if (isError) {
                elements.statusMessage.classList.add('bg-red-900', 'border-red-500');
                elements.statusSpinner.classList.add('hidden');
            } else if (autoHide) {
                elements.statusMessage.classList.add('bg-green-900', 'border-green-500');
                elements.statusSpinner.classList.add('hidden');
            } else {
                elements.statusMessage.classList.add('bg-blue-900', 'border-blue-500');
            }

            if (autoHide) {
                elements.statusMessage.classList.remove('animate-pulse');
                setTimeout(() => {
                    elements.statusMessage.classList.add('hidden');
                }, 5000);
            }
        }

        // Uruchomienie aplikacji
        connect();
    </script>
</body>
</html>

