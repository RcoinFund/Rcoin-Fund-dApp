<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rcoin Fund dApp v4.4 (Ulepszone Wpłaty)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .btn {
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s;
            width: 100%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-blue { background-color: #3b82f6; color: white; }
        .btn-blue:hover:not(:disabled) { background-color: #2563eb; }
        .btn-red { background-color: #ef4444; color: white; }
        .btn-red:hover:not(:disabled) { background-color: #dc2626; }
        .tab-active { background-color: #3b82f6; color: white; }
        .tab-inactive { background-color: #374151; color: #d1d5db; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .input-field {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

<div class="w-full max-w-5xl mx-auto">
    <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
        <div class="flex items-center gap-3">
            <svg class="w-10 h-10 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 10v-1m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3 .895 3 2-1.343 2-3 2m0 0c-1.11 0-2.08-.402-2.599-1M12 18v-1m0-10V7m0 11h.01"></path></svg>
            <h1 class="text-4xl font-bold text-white">Rcoin Fund</h1>
        </div>
        <button id="connectButton" class="btn btn-blue sm:w-auto">Połącz Portfel</button>
    </header>

    <main id="dappInterface" class="hidden">
        <!-- Dashboard -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Twoje Saldo Rcoin</h3><p id="rcoinBalance" class="text-2xl font-semibold text-white mt-1">...</p></div>
            <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Twoje Saldo USDC</h3><p id="usdcBalance" class="text-2xl font-semibold text-white mt-1">...</p></div>
            <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Kurs Rcoin</h3><p id="exchangeRate" class="text-2xl font-semibold text-white mt-1">...</p></div>
        </section>

        <!-- Client Actions -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ======================= START ZMIENIONEGO KAFELKA WPŁAT ======================= -->
            <div class="bg-gray-800 p-8 rounded-xl flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-6 text-white">Wpłata USDC</h2>
                    
                    <!-- Limit Wpłat -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-400">Ustawiony limit wpłat</label>
                            <button id="changeLimitButton" class="text-blue-400 hover:text-blue-300 text-sm font-semibold">Zmień</button>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2">
                            <div id="limitProgressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="depositLimit" class="text-lg font-semibold text-white text-right">0.00 USDC</p>
                    </div>

                    <!-- Sekcja zmiany limitu (początkowo ukryta) -->
                    <div id="setLimitSection" class="hidden space-y-4 mb-6 p-4 bg-gray-900/50 rounded-lg">
                        <label for="newLimitAmount" class="block text-sm font-medium text-gray-300">Wprowadź nowy, łączny limit dla przyszłych wpłat</label>
                        <div class="flex space-x-3">
                            <input type="number" id="newLimitAmount" placeholder="np. 1000" class="input-field flex-grow">
                            <button id="setLimitButton" class="btn btn-blue w-auto px-6">Ustaw</button>
                        </div>
                         <p class="text-xs text-gray-500">Ustawiasz maksymalną kwotę USDC, którą kontrakt może pobrać z Twojego portfela. Możesz ustawić duży limit raz, by potem dokonywać wielu mniejszych wpłat.</p>
                    </div>

                    <!-- Sekcja Wpłaty -->
                    <div class="space-y-4">
                        <div>
                            <label for="depositAmount" class="block text-sm font-medium text-gray-400">Kwota do wpłaty</p>
                            <input type="number" id="depositAmount" placeholder="0.00" class="input-field mt-1 text-lg">
                        </div>
                        <button id="depositButton" class="btn btn-blue" disabled>Wpłać</button>
                        <p id="depositError" class="text-red-400 text-sm text-center h-4"></p>
                    </div>
                </div>
            </div>
            <!-- ======================= KONIEC ZMIENIONEGO KAFELKA WPŁAT ======================= -->

            <div class="bg-gray-800 p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 text-white">Wypłata</h2>
                <div class="flex border-b border-gray-700 mb-6">
                    <button id="tabInstant" class="tab-active flex-1 py-2 text-center font-semibold transition-colors duration-300 rounded-t-md">Natychmiastowa</button>
                    <button id="tabDelayed" class="tab-inactive flex-1 py-2 text-center font-semibold transition-colors duration-300 rounded-t-md">Opóźniona</button>
                </div>
                <div id="instantWithdrawPanel">
                    <p class="text-sm text-gray-400 mb-4">Wypłać natychmiastowo z opłatą <span id="feeInfo">...</span>%.</p>
                    <div class="space-y-4">
                        <div><label for="instantWithdrawAmount" class="block text-sm font-medium text-gray-400">Kwota USDC do wypłaty</label><input type="number" id="instantWithdrawAmount" placeholder="0.00" class="input-field mt-1 sm:text-lg"></div>
                        <button id="instantWithdrawButton" class="btn btn-red">Wypłać Natychmiast</button>
                    </div>
                </div>
                <div id="delayedWithdrawPanel" class="hidden">
                    <div id="requestSection">
                        <p class="text-sm text-gray-400 mb-4">Złóż wniosek o wypłatę bez opłat. Środki będą dostępne po <span id="delayInfo">...</span>.</p>
                        <div><label for="delayedWithdrawAmount" class="block text-sm font-medium text-gray-400">Kwota USDC do wypłaty</label><input type="number" id="delayedWithdrawAmount" placeholder="0.00" class="input-field mt-1 sm:text-lg"></div>
                        <button id="requestDelayedWithdrawButton" class="mt-4 btn btn-blue">Złóż Wniosek</button>
                    </div>
                    <div id="manageSection" class="hidden text-center">
                        <p class="text-lg text-gray-300 mb-2">Masz aktywny wniosek o wypłatę:</p>
                        <p class="text-3xl font-bold text-white mb-4"><span id="pendingAmount">0.00</span> USDC</p>
                        <p id="unlockTime" class="font-semibold mb-6">...</p>
                        <div class="space-y-3">
                            <button id="fulfillDelayedWithdrawButton" disabled class="btn btn-blue">Odbierz Środki</button>
                            <button id="cancelDelayedWithdrawButton" class="btn btn-blue">Anuluj Wniosek</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Fund Manager Actions -->
        <section id="fundManagerSection" class="mt-8 bg-gray-800/50 border border-blue-500/30 p-8 rounded-xl hidden">
            <h2 class="text-2xl font-bold mb-6 text-blue-300">Panel Menedżera Funduszu</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Wartość Funduszu (TVL)</h3><p id="tvl" class="text-2xl font-semibold text-white mt-1">...</p></div>
                <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Saldo Off-Chain</h3><p id="offChainBalanceDisplay" class="text-2xl font-semibold text-white mt-1">...</p></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                <div class="space-y-4"><label for="transferToManagerAmount" class="block text-sm font-medium text-gray-400">Transferuj do zarządzania (off-chain)</label><input type="number" id="transferToManagerAmount" placeholder="0.00" class="input-field mt-1"><button id="transferToManagerButton" class="btn btn-blue">Transferuj USDC</button></div>
                <div class="space-y-4"><label for="transferToVaultAmount" class="block text-sm font-medium text-gray-400">Zwróć środki do skarbca</label><input type="number" id="transferToVaultAmount" placeholder="0.00" class="input-field mt-1"><button id="transferToVaultButton" class="btn btn-blue">Zwróć USDC</button></div>
                <div class="space-y-4"><label for="offChainValueAmount" class="block text-sm font-medium text-gray-400">Zaktualizuj wartość aktywów off-chain</label><input type="number" id="offChainValueAmount" placeholder="0.00" class="input-field mt-1"><button id="updateOffChainValueButton" class="btn btn-blue">Aktualizuj Wartość</button></div>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-4 text-white">Historia Wniosków o Wypłatę (ostatnie 60 dni)</h3>
                <div class="bg-gray-800 p-4 rounded-lg max-h-60 overflow-y-auto">
                    <ul id="pendingRequestsList" class="space-y-3">
                        <!-- JS will inject requests here -->
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <!-- Status Message -->
    <div id="statusMessage" class="fixed bottom-5 right-5 bg-gray-800 border-l-4 p-4 rounded-lg shadow-lg max-w-sm hidden">
        <div class="flex items-center">
            <div id="statusSpinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-3"></div>
            <p id="statusText" class="text-white"></p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dApp = {
        // -- KONFIGURACJA ---
        config: {
            vaultContractAddress: "0xD0D551e57971C94e42244BE0f98C3a05EC3C08E5",
            usdcContractAddress: "0x41E94Eb019C0762f9Bfcf9Fb1E58725BfB0e7582",
            desiredChainId: 80002, // Polygon Amoy
            desiredChainHex: '0x13882',
        },

        // -- STAN APLIKACJI ---
        state: {
            provider: null, signer: null, userAddress: null, fundManagerAddress: null,
            contracts: { vault: null, usdc: null },
            usdcAllowance: ethers.BigNumber.from(0), // NOWY STAN: Przechowuje aktualny limit (allowance)
        },
        
        // -- ELEMENTY DOM ---
        elements: {},

        // -- INICJALIZACJA ---
        async init() {
            // ZAKTUALIZOWANA LISTA ID ELEMENTÓW
            const ids = [
                "connectButton", "dappInterface", "rcoinBalance", "usdcBalance", "exchangeRate", "tvl",
                "depositAmount", "depositButton", "depositLimit", "depositError",
                "changeLimitButton", "setLimitSection", "newLimitAmount", "setLimitButton", "limitProgressBar",
                "instantWithdrawAmount", "instantWithdrawButton", "delayedWithdrawAmount", 
                "requestDelayedWithdrawButton", "fulfillDelayedWithdrawButton", "cancelDelayedWithdrawButton", 
                "tabInstant", "tabDelayed", "instantWithdrawPanel", "delayedWithdrawPanel", "requestSection", 
                "manageSection", "pendingAmount", "unlockTime", "feeInfo", "delayInfo", "fundManagerSection", 
                "transferToManagerAmount", "transferToManagerButton", "transferToVaultAmount", "transferToVaultButton", 
                "offChainValueAmount", "updateOffChainValueButton", "statusMessage", "statusText", "statusSpinner", 
                "offChainBalanceDisplay", "pendingRequestsList"
            ];
            ids.forEach(id => this.elements[id] = document.getElementById(id));
            this.setupEventListeners();
            if (window.ethereum && window.ethereum.selectedAddress) {
                this.connectWallet();
            }
        },

        // -- NASŁUCHIWANIE ZDARZEŃ ---
        setupEventListeners() {
            this.elements.connectButton.addEventListener('click', () => this.connectWallet());
            
            // NOWA LOGIKA WPŁAT
            this.elements.changeLimitButton.addEventListener('click', () => this.toggleSetLimitSection());
            this.elements.setLimitButton.addEventListener('click', () => this.handleSetLimit());
            this.elements.depositButton.addEventListener('click', () => this.handleDeposit());
            this.elements.depositAmount.addEventListener('input', () => this.validateDepositAmount());

            // Pozostałe event listenery
            this.elements.instantWithdrawButton.addEventListener('click', () => this.handleInstantWithdraw());
            this.elements.requestDelayedWithdrawButton.addEventListener('click', () => this.handleRequestDelayedWithdraw());
            this.elements.fulfillDelayedWithdrawButton.addEventListener('click', () => this.handleFulfillDelayedWithdraw());
            this.elements.cancelDelayedWithdrawButton.addEventListener('click', () => this.handleCancelDelayedWithdraw());
            this.elements.tabInstant.addEventListener('click', () => this.switchTab('instant'));
            this.elements.tabDelayed.addEventListener('click', () => this.switchTab('delayed'));
            this.elements.transferToManagerButton.addEventListener('click', () => this.handleTransferToManager());
            this.elements.transferToVaultButton.addEventListener('click', () => this.handleTransferToVault());
            this.elements.updateOffChainValueButton.addEventListener('click', () => this.handleUpdateOffChainValue());
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => this.handleAccountsChanged(accounts));
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        },

        // ==========================================================
        // =========== NOWE I ZMODYFIKOWANE FUNKCJE WPŁAT ===========
        // ==========================================================

        toggleSetLimitSection() {
            this.elements.setLimitSection.classList.toggle('hidden');
        },

        async updateDepositUI() {
            if (!this.state.contracts.usdc || !this.state.userAddress) return;

            try {
                this.state.usdcAllowance = await this.state.contracts.usdc.allowance(this.state.userAddress, this.config.vaultContractAddress);
                const allowanceFormatted = ethers.utils.formatUnits(this.state.usdcAllowance, 6);
                
                this.elements.depositLimit.innerText = `${this.formatNumber(allowanceFormatted)} USDC`;
                
                // Aktualizacja paska postępu
                const hasAllowance = this.state.usdcAllowance.gt(0);
                this.elements.limitProgressBar.style.width = hasAllowance ? '100%' : '0%';
                this.elements.limitProgressBar.classList.toggle('bg-green-500', hasAllowance);
                this.elements.limitProgressBar.classList.toggle('bg-blue-600', !hasAllowance);

                this.validateDepositAmount(); // Sprawdź ponownie po aktualizacji limitu
            } catch (error) {
                console.error("Błąd podczas aktualizacji UI wpłat:", error);
                this.elements.depositLimit.innerText = "Błąd odczytu";
            }
        },

        validateDepositAmount() {
            const amountStr = this.elements.depositAmount.value;
            this.elements.depositError.innerText = '';
            
            if (!amountStr || isNaN(amountStr) || parseFloat(amountStr) <= 0) {
                this.elements.depositButton.disabled = true;
                return;
            }

            try {
                const amount = ethers.utils.parseUnits(amountStr, 6);

                if (amount.gt(this.state.usdcAllowance)) {
                    this.elements.depositButton.disabled = true;
                    this.elements.depositError.innerText = 'Kwota przekracza ustawiony limit.';
                } else {
                    this.elements.depositButton.disabled = false;
                }
            } catch (error) {
                this.elements.depositButton.disabled = true;
                this.elements.depositError.innerText = 'Nieprawidłowa kwota.';
            }
        },

        async handleSetLimit() {
            const amountStr = this.elements.newLimitAmount.value;
            if (!amountStr || isNaN(amountStr) || parseFloat(amountStr) < 0) {
                return this.showStatus("Wprowadź prawidłową kwotę limitu.", "error");
            }
            try {
                const amount = ethers.utils.parseUnits(amountStr, 6);
                await this.executeTransaction(
                    () => this.state.contracts.usdc.approve(this.config.vaultContractAddress, amount),
                    "Ustawianie nowego limitu...",
                    "Limit wpłat został pomyślnie zaktualizowany!"
                );
                this.elements.newLimitAmount.value = '';
                this.toggleSetLimitSection();
            } catch (error) {
                console.error("Błąd podczas ustawiania limitu:", error);
                this.showStatus("Transakcja ustawienia limitu nie powiodła się.", "error");
            }
        },
        
        async handleDeposit() {
            const amountStr = this.elements.depositAmount.value;
            try {
                const assets = ethers.utils.parseUnits(amountStr, 6);
                await this.executeTransaction(
                    () => this.state.contracts.vault.deposit(assets, this.state.userAddress),
                    "Przetwarzanie wpłaty...",
                    "Wpłata zakończona pomyślnie!"
                );
                this.elements.depositAmount.value = '';
            } catch (error) {
                console.error("Błąd podczas wpłaty:", error);
                this.showStatus("Transakcja wpłaty nie powiodła się.", "error");
            }
        },
        
        // ==========================================================
        // =========== KONIEC NOWYCH FUNKCJI WPŁAT ==================
        // ==========================================================


        // -- LOGIKA PORTFELA I KONTRAKTÓW ---
        async connectWallet() {
            if (!window.ethereum) return this.showStatus("Zainstaluj MetaMask!", "error");
            try {
                await this.checkNetwork();
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                this.handleAccountsChanged(accounts);
            } catch (error) {
                console.error("Błąd połączenia z portfelem:", error);
                this.showStatus("Błąd połączenia z portfelem", "error");
            }
        },

        async checkNetwork() {
            const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (currentChainId !== this.config.desiredChainHex) {
                this.showStatus("Proszę przełączyć na sieć Polygon Amoy", "info");
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: this.config.desiredChainHex }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) this.showStatus("Dodaj sieć Polygon Amoy do MetaMask", "error");
                    else throw switchError;
                }
            }
        },

        async handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                this.state.userAddress = null;
                this.elements.dappInterface.classList.add('hidden');
                this.elements.connectButton.innerText = "Połącz Portfel";
            } else {
                this.state.userAddress = accounts[0];
                this.elements.connectButton.innerText = `${this.state.userAddress.substring(0, 6)}...${this.state.userAddress.substring(38)}`;
                this.elements.dappInterface.classList.remove('hidden');
                await this.initializeContracts();
                await this.startApp();
            }
        },

        async initializeContracts() {
            this.state.provider = new ethers.providers.Web3Provider(window.ethereum);
            this.state.signer = this.state.provider.getSigner();

            const vaultABI = [{"inputs":[{"internalType":"address","name":"_fundManager","type":"address"},{"internalType":"address","name":"_feeRecipient","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"ERC4626ExceededMaxTotalAssets","type":"error"},{"inputs":[],"name":"ERC4626InvalidReceiver","type":"error"},{"inputs":[],"name":"ERC4626InvalidSender","type":"error"},{"inputs":[],"name":"ERC4626InvalidShares","type":"error"},{"inputs":[],"name":"ERC4626ZeroAssets","type":"error"},{"inputs":[],"name":"ERC4626ZeroShares","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"AssetsTransferredToManager","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"AssetsTransferredToVault","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"DelayedWithdrawalCanceled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"fulfiller","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsRedeemed","type":"uint256"}],"name":"DelayedWithdrawalFulfilled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsToRedeem","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"unlockTime","type":"uint256"}],"name":"DelayedWithdrawalRequested","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"caller","type":"address"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"assets","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shares","type":"uint256"}],"name":"Deposit","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldRecipient","type":"address"},{"indexed":true,"internalType":"address","name":"newRecipient","type":"address"}],"name":"FeeRecipientUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"newFeeBps","type":"uint16"}],"name":"InstantWithdrawalFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsRedeemed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"feeAmount","type":"uint256"}],"name":"InstantWithdrawal","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newBalance","type":"uint256"}],"name":"OffChainBalanceUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newTotalValue","type":"uint256"}],"name":"OffChainAssetValueUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newDelay","type":"uint256"}],"name":"WithdrawalDelayUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"caller","type":"address"},{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"assets","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shares","type":"uint256"}],"name":"Withdraw","type":"event"},{"inputs":[],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"asset","outputs":[{"internalType":"contract IERC20Metadata","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"cancelDelayedWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"convertToAssets","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"name":"convertToShares","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"}],"name":"deposit","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeRecipient","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"client","type":"address"}],"name":"fulfillDelayedWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"fundManager","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getExchangeRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getOffChainBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToRedeem","type":"uint256"}],"name":"instantWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"instantWithdrawalFeeBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxMint","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"maxRedeem","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"maxWithdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"}],"name":"mint","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"name":"previewDeposit","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"previewMint","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"previewRedeem","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"name":"previewWithdraw","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"redeem","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToRedeem","type":"uint256"}],"name":"requestDelayedWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newFeeRecipient","type":"address"}],"name":"setFeeRecipient","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newFundManager","type":"address"}],"name":"setFundManager","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_newFeeBps","type":"uint16"}],"name":"setInstantWithdrawalFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newDelay","type":"uint256"}],"name":"setWithdrawalDelay","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalAssets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToTransfer","type":"uint256"}],"name":"transferAssetsToFundManager","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToTransfer","type":"uint256"}],"name":"transferAssetsToVault","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newTotalValue","type":"uint256"}],"name":"updateOffChainAssetValue","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"withdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawalDelayPeriod","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"withdrawalRequests","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];
            const usdcABI = [{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

            this.state.contracts.vault = new ethers.Contract(this.config.vaultContractAddress, vaultABI, this.state.signer);
            this.state.contracts.usdc = new ethers.Contract(this.config.usdcContractAddress, usdcABI, this.state.signer);
        },

        async startApp() {
            this.showStatus("Ładowanie danych...", "loading");
            await this.updateAllUI();
            this.hideStatus(1000);
        },
        
        // ZMODYFIKOWANA GŁÓWNA FUNKCJA AKTUALIZACJI UI
        async updateAllUI() {
            const promises = [
                this.updateBalances(),
                this.updateVaultInfo(),
                this.updateWithdrawalUI(),
                this.updateDepositUI(), // DODANO AKTUALIZACJĘ UI WPŁAT
                this.checkFundManagerStatus()
            ];
            await Promise.all(promises);
        },
        
        async updateBalances() { /* ... bez zmian ... */ },
        async updateVaultInfo() { /* ... bez zmian ... */ },
        async updateWithdrawalUI() { /* ... bez zmian ... */ },
        async checkFundManagerStatus() { /* ... bez zmian ... */ },
        async updateManagerUI() { /* ... bez zmian ... */ },
        async fetchPendingRequests() { /* ... bez zmian ... */ },
        
        // --- POZOSTAŁA LOGIKA OBSŁUGI ---
        handleInstantWithdraw() { /* ... bez zmian ... */ },
        handleRequestDelayedWithdraw() { /* ... bez zmian ... */ },
        handleFulfillDelayedWithdraw() { /* ... bez zmian ... */ },
        handleCancelDelayedWithdraw() { /* ... bez zmian ... */ },
        handleTransferToManager() { /* ... bez zmian ... */ },
        handleTransferToVault() { /* ... bez zmian ... */ },
        handleUpdateOffChainValue() { /* ... bez zmian ... */ },
        switchTab(tab) { /* ... bez zmian ... */ },
        
        // --- FUNKCJE POMOCNICZE ---
        async executeTransaction(txFunction, loadingMessage, successMessage) {
            this.showStatus(loadingMessage, "loading");
            try {
                const tx = await txFunction();
                await tx.wait();
                this.showStatus(successMessage, "success");
                await this.updateAllUI(); // Odśwież wszystko
                this.hideStatus(3000);
            } catch (error) {
                console.error("Błąd transakcji:", error);
                this.showStatus(error.reason || "Transakcja nie powiodła się.", "error");
                this.hideStatus(5000);
                throw error; // Rzuć błąd dalej, aby można było go złapać w funkcji wywołującej
            }
        },
        
        showStatus(message, type = "info") { /* ... bez zmian ... */ },
        hideStatus(delay = 0) { /* ... bez zmian ... */ },
        formatNumber(num, decimals = 2) { /* ... bez zmian ... */ },
        formatRelativeTime(timestamp) { /* ... bez zmian ... */ }
    };
    
    // Uzupełnij brakujące funkcje, kopiując je z Twojego oryginalnego pliku.
    // Poniżej wkleiłem te, które nie wymagały zmian, aby kod był kompletny.
    
    // -- UZUPEŁNIENIE FUNKCJI, KTÓRE SIĘ NIE ZMIENIŁY --

    dApp.updateBalances = async function() {
        try {
            const [rcoinBal, usdcBal] = await Promise.all([
                this.state.contracts.vault.balanceOf(this.state.userAddress),
                this.state.contracts.usdc.balanceOf(this.state.userAddress)
            ]);
            this.elements.rcoinBalance.innerText = this.formatNumber(ethers.utils.formatUnits(rcoinBal, 18));
            this.elements.usdcBalance.innerText = this.formatNumber(ethers.utils.formatUnits(usdcBal, 6));
        } catch (error) {
            console.error("Błąd odczytu sald:", error);
        }
    };

    dApp.updateVaultInfo = async function() {
        try {
            const [rate, tvl] = await Promise.all([
                this.state.contracts.vault.getExchangeRate(),
                this.state.contracts.vault.totalAssets()
            ]);
            this.elements.exchangeRate.innerText = `1 RCOIN = ${this.formatNumber(ethers.utils.formatUnits(rate, 18), 6)} USDC`;
            this.elements.tvl.innerText = `${this.formatNumber(ethers.utils.formatUnits(tvl, 6))} USDC`;
        } catch (error) {
            console.error("Błąd odczytu informacji o skarbcu:", error);
        }
    };

    dApp.updateWithdrawalUI = async function() {
        try {
            const [feeBps, delay, request] = await Promise.all([
                this.state.contracts.vault.instantWithdrawalFeeBps(),
                this.state.contracts.vault.withdrawalDelayPeriod(),
                this.state.contracts.vault.withdrawalRequests(this.state.userAddress)
            ]);

            this.elements.feeInfo.innerText = feeBps / 100;
            this.elements.delayInfo.innerText = `${delay / 86400} dni`;

            if (request.timestamp.gt(0)) {
                this.elements.requestSection.classList.add('hidden');
                this.elements.manageSection.classList.remove('hidden');

                const pendingAmountFormatted = ethers.utils.formatUnits(request.assets, 6);
                this.elements.pendingAmount.innerText = this.formatNumber(pendingAmountFormatted);

                const unlockTimestamp = request.timestamp.add(delay).toNumber();
                const now = Math.floor(Date.now() / 1000);

                if (now >= unlockTimestamp) {
                    this.elements.unlockTime.innerText = "Środki gotowe do odbioru!";
                    this.elements.unlockTime.className = "font-semibold mb-6 text-green-400";
                    this.elements.fulfillDelayedWithdrawButton.disabled = false;
                } else {
                    this.elements.unlockTime.innerText = `Dostępne za: ${this.formatRelativeTime(unlockTimestamp)}`;
                    this.elements.unlockTime.className = "font-semibold mb-6 text-yellow-400";
                    this.elements.fulfillDelayedWithdrawButton.disabled = true;
                }
            } else {
                this.elements.requestSection.classList.remove('hidden');
                this.elements.manageSection.classList.add('hidden');
            }
        } catch (error) {
            console.error("Błąd aktualizacji UI wypłat:", error);
        }
    };
    
    dApp.checkFundManagerStatus = async function() {
        try {
            const owner = await this.state.contracts.vault.owner();
            const fundManager = await this.state.contracts.vault.fundManager();
            this.state.fundManagerAddress = fundManager;

            if (this.state.userAddress.toLowerCase() === owner.toLowerCase() || this.state.userAddress.toLowerCase() === fundManager.toLowerCase()) {
                this.elements.fundManagerSection.classList.remove('hidden');
                await this.updateManagerUI();
            } else {
                this.elements.fundManagerSection.classList.add('hidden');
            }
        } catch (error) {
            console.error("Błąd sprawdzania statusu menedżera:", error);
        }
    };

    dApp.updateManagerUI = async function() {
        try {
            const offChainBalance = await this.state.contracts.vault.getOffChainBalance();
            this.elements.offChainBalanceDisplay.innerText = `${this.formatNumber(ethers.utils.formatUnits(offChainBalance, 6))} USDC`;
            await this.fetchPendingRequests();
        } catch (error) {
            console.error("Błąd aktualizacji UI menedżera:", error);
        }
    };

    dApp.fetchPendingRequests = async function() {
        this.elements.pendingRequestsList.innerHTML = '<li>Ładowanie wniosków...</li>';
        try {
            const filter = this.state.contracts.vault.filters.DelayedWithdrawalRequested();
            const logs = await this.state.contracts.vault.queryFilter(filter, -60 * 24 * 30 * 2, 'latest'); // Ostatnie ~60 dni
            
            const activeRequests = new Map();
            for (const log of logs) {
                const user = log.args.user;
                const request = await this.state.contracts.vault.withdrawalRequests(user);
                if (request.timestamp.gt(0)) {
                    activeRequests.set(user.toLowerCase(), {
                        user: user,
                        amount: ethers.utils.formatUnits(request.assets, 6),
                        unlockTime: request.timestamp.add(await this.state.contracts.vault.withdrawalDelayPeriod()).toNumber()
                    });
                }
            }

            if (activeRequests.size === 0) {
                this.elements.pendingRequestsList.innerHTML = '<li>Brak aktywnych wniosków.</li>';
                return;
            }

            let html = '';
            for (const [_, req] of activeRequests.entries()) {
                const isReady = Date.now() / 1000 > req.unlockTime;
                html += `
                    <li class="flex justify-between items-center p-2 rounded ${isReady ? 'bg-green-900/50' : 'bg-gray-700/50'}">
                        <div>
                            <p class="font-mono text-xs">${req.user}</p>
                            <p class="font-bold">${this.formatNumber(req.amount)} USDC</p>
                        </div>
                        <span class="text-xs font-semibold ${isReady ? 'text-green-400' : 'text-yellow-400'}">
                            ${isReady ? 'GOTOWY' : this.formatRelativeTime(req.unlockTime)}
                        </span>
                    </li>`;
            }
            this.elements.pendingRequestsList.innerHTML = html;
        } catch (e) {
            console.error("Błąd podczas pobierania wniosków:", e);
            this.elements.pendingRequestsList.innerHTML = '<li>Wystąpił błąd podczas ładowania.</li>';
        }
    };
    
    dApp.handleInstantWithdraw = async function() {
        const amountStr = this.elements.instantWithdrawAmount.value;
        if (!amountStr || isNaN(amountStr) || parseFloat(amountStr) <= 0) return this.showStatus("Wprowadź prawidłową kwotę.", "error");
        try {
            const assets = ethers.utils.parseUnits(amountStr, 6);
            await this.executeTransaction(
                () => this.state.contracts.vault.instantWithdrawal(assets),
                "Przetwarzanie wypłaty natychmiastowej...",
                "Wypłata zakończona pomyślnie!"
            );
            this.elements.instantWithdrawAmount.value = '';
        } catch (error) {
            // executeTransaction już pokazuje błąd
        }
    };

    dApp.handleRequestDelayedWithdraw = async function() {
        const amountStr = this.elements.delayedWithdrawAmount.value;
        if (!amountStr || isNaN(amountStr) || parseFloat(amountStr) <= 0) return this.showStatus("Wprowadź prawidłową kwotę.", "error");
        try {
            const assets = ethers.utils.parseUnits(amountStr, 6);
            await this.executeTransaction(
                () => this.state.contracts.vault.requestDelayedWithdrawal(assets),
                "Składanie wniosku o wypłatę...",
                "Wniosek został pomyślnie złożony!"
            );
            this.elements.delayedWithdrawAmount.value = '';
        } catch (error) {
           // executeTransaction już pokazuje błąd
        }
    };

    dApp.handleFulfillDelayedWithdraw = async function() {
        await this.executeTransaction(
            () => this.state.contracts.vault.fulfillDelayedWithdrawal(this.state.userAddress),
            "Odbieranie środków...",
            "Środki zostały pomyślnie wypłacone!"
        );
    };

    dApp.handleCancelDelayedWithdraw = async function() {
        await this.executeTransaction(
            () => this.state.contracts.vault.cancelDelayedWithdrawal(),
            "Anulowanie wniosku...",
            "Wniosek o wypłatę został anulowany."
        );
    };
    
    dApp.handleTransferToManager = async function() {
        const amountStr = this.elements.transferToManagerAmount.value;
        if (!amountStr || parseFloat(amountStr) <= 0) return;
        const amount = ethers.utils.parseUnits(amountStr, 6);
        await this.executeTransaction(
            () => this.state.contracts.vault.transferAssetsToFundManager(amount),
            "Transferowanie środków do menedżera...",
            "Środki pomyślnie przetransferowane."
        );
    };

    dApp.handleTransferToVault = async function() {
        const amountStr = this.elements.transferToVaultAmount.value;
        if (!amountStr || parseFloat(amountStr) <= 0) return;
        const amount = ethers.utils.parseUnits(amountStr, 6);
        const usdc = this.state.contracts.usdc;
        const vaultAddr = this.config.vaultContractAddress;
        
        this.showStatus("Zatwierdzanie transferu USDC...", "loading");
        try {
            const allowance = await usdc.allowance(this.state.userAddress, vaultAddr);
            if (allowance.lt(amount)) {
                const approveTx = await usdc.approve(vaultAddr, amount);
                await approveTx.wait();
            }
            await this.executeTransaction(
                () => this.state.contracts.vault.transferAssetsToVault(amount),
                "Zwracanie środków do skarbca...",
                "Środki pomyślnie zwrócone."
            );
        } catch(e) {
            console.error("Błąd przy transferze do skarbca:", e);
            this.showStatus("Błąd transferu do skarbca.", "error");
            this.hideStatus(4000);
        }
    };

    dApp.handleUpdateOffChainValue = async function() {
        const amountStr = this.elements.offChainValueAmount.value;
        if (!amountStr || parseFloat(amountStr) < 0) return;
        const amount = ethers.utils.parseUnits(amountStr, 6);
        await this.executeTransaction(
            () => this.state.contracts.vault.updateOffChainAssetValue(amount),
            "Aktualizowanie wartości off-chain...",
            "Wartość pomyślnie zaktualizowana."
        );
    };

    dApp.switchTab = function(tab) {
        if (tab === 'instant') {
            this.elements.tabInstant.classList.replace('tab-inactive', 'tab-active');
            this.elements.tabDelayed.classList.replace('tab-active', 'tab-inactive');
            this.elements.instantWithdrawPanel.classList.remove('hidden');
            this.elements.delayedWithdrawPanel.classList.add('hidden');
        } else {
            this.elements.tabInstant.classList.replace('tab-active', 'tab-inactive');
            this.elements.tabDelayed.classList.replace('tab-inactive', 'tab-active');
            this.elements.instantWithdrawPanel.classList.add('hidden');
            this.elements.delayedWithdrawPanel.classList.remove('hidden');
        }
    };

    dApp.showStatus = function(message, type = "info") {
        this.elements.statusText.innerText = message;
        const statusDiv = this.elements.statusMessage;
        statusDiv.classList.remove('hidden');
        
        statusDiv.className = statusDiv.className.replace(/border-l-(blue|green|red|yellow)-500/g, '');

        switch(type) {
            case "loading": statusDiv.classList.add('border-l-blue-500'); this.elements.statusSpinner.classList.remove('hidden'); break;
            case "success": statusDiv.classList.add('border-l-green-500'); this.elements.statusSpinner.classList.add('hidden'); break;
            case "error": statusDiv.classList.add('border-l-red-500'); this.elements.statusSpinner.classList.add('hidden'); break;
            default: statusDiv.classList.add('border-l-yellow-500'); this.elements.statusSpinner.classList.add('hidden'); break;
        }
    };

    dApp.hideStatus = function(delay = 0) {
        setTimeout(() => {
            this.elements.statusMessage.classList.add('hidden');
        }, delay);
    };

-
    dApp.formatNumber = function(num, decimals = 2) {
        const number = parseFloat(num);
        if (isNaN(number)) return '0.00';
        return number.toLocaleString('pl-PL', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    };

    dApp.formatRelativeTime = function(timestamp) {
        const now = new Date();
        const future = new Date(timestamp * 1000);
        const diffSeconds = Math.round((future - now) / 1000);

        if (diffSeconds < 60) return `${diffSeconds} sek.`;
        const diffMinutes = Math.round(diffSeconds / 60);
        if (diffMinutes < 60) return `${diffMinutes} min.`;
        const diffHours = Math.round(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours} godz.`;
        const diffDays = Math.round(diffHours / 24);
        return `${diffDays} dni`;
    };

    dApp.init();
});
</script>
</body>
</html>
