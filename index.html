<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Rcoin Fund dApp v5.3 (Multi-Wallet Support)</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
   <!-- ZMIANA: Dodano skrypt Web3Modal -->
   <script src="https://unpkg.com/@web3modal/ethers5@3.1.0/dist/ethers5.index.js"></script>
   <style>
       @import url('https://fonts.googleapis.com/css?family=Inter:wght@400;500;600;700&display=swap');
       body { font-family: 'Inter', sans-serif; }
       .btn { font-weight: bold; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.3s, transform 0.1s; width: 100%; cursor: pointer; }
       .btn:active { transform: scale(0.98); }
       .btn-blue { background-color: #3b82f6; color: white; }
       .btn-blue:hover { background-color: #2563eb; }
       .btn-red { background-color: #ef4444; color: white; }
       .btn-red:hover { background-color: #dc2626; }
       .tab-active { background-color: #3b82f6; color: white; }
       .tab-inactive { background-color: #374151; color: #d1d5db; }
       .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
       @keyframes spin { to { transform: rotate(360deg); } }
       ::-webkit-scrollbar { width: 8px; }
       ::-webkit-scrollbar-track { background: #1f2937; }
       ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
       ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
   </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

<div class="w-full max-w-5xl mx-auto">
   <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
       <div class="flex items-center gap-3">
           <svg class="w-10 h-10 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 10v-1m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3 .895 3 2-1.343 2-3 2m0 0c-1.11 0-2.08-.402-2.599-1M12 18v-1m0-10V7m0 11h.01"></path></svg>
           <h1 class="text-4xl font-bold text-white">Rcoin Fund</h1>
       </div>
        
       <div class="w-full sm:w-auto flex items-center justify-between sm:justify-end sm:gap-6 mt-4 sm:mt-0">
            <a href="https://x.com/rcoinfund" target="_blank" rel="noopener noreferrer" title="Odwiedź nas na X" class="text-gray-400 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 16 16"><path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865l8.875 11.633Z"/></svg>
            </a>
            
            <div class="sm:order-last">
                <button id="connectButton" class="btn btn-blue w-auto min-w-[150px]">Połącz Portfel</button>
            </div>
            
            <a href="https://discord.gg/66DR6Mhpyz" target="_blank" rel="noopener noreferrer" title="Dołącz do naszego Discorda" class="text-gray-400 hover:text-white transition-colors">
                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.073 0a.052.052 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1 .015.019.05.05 0 0 1-.02.066 8.875 8.875 0 0 1-1.248.595.05.05 0 0 0-.01.059c.236.466.51.899.818 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4-2.02.049.049 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034 0 0 0-.021-.018Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z"/></svg>
            </a>
       </div>
   </header>

   <main id="dappInterface" class="hidden">
       <!-- Reszta UI bez zmian -->
       <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
           <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Twoje Saldo Rcoin</h3><p id="rcoinBalance" class="text-2xl font-semibold text-white mt-1">...</p></div>
           <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Twoje Saldo USDC</h3><p id="usdcBalance" class="text-2xl font-semibold text-white mt-1">...</p></div>
           <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Cena udziałów Rcoin</h3><p id="exchangeRate" class="text-2xl font-semibold text-white mt-1">...</p></div>
       </section>
       <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
           <div class="bg-gray-800 p-8 rounded-xl flex flex-col justify-between">
               <h2 class="text-2xl font-bold mb-4 text-white">Wpłata USDC</h2>
               <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                   <div class="flex justify-between items-center text-sm mb-2"><span class="text-gray-400 font-medium">Ustawiony Limit Wpłat</span><button id="toggleLimitButton" class="text-blue-400 hover:text-blue-300 text-xs font-semibold">ZMIEŃ</button></div>
                   <p id="allowanceInfo" class="text-2xl font-semibold text-white">... USDC</p>
               </div>
               <div id="depositActionSection" class="space-y-4">
                   <div>
                       <label for="depositAmount" class="block text-sm font-medium text-gray-400">Kwota do wpłaty</label>
                       <div class="relative mt-1"><input type="number" id="depositAmount" placeholder="0.00" class="block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500 sm:text-lg p-3 pr-16"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400">USDC</span></div>
                   </div>
                   <button id="depositButton" class="btn btn-blue">Wpłać</button>
               </div>
               <div id="setLimitSection" class="hidden space-y-4">
                   <div>
                       <label for="limitAmount" class="block text-sm font-medium text-gray-400">Nowy limit wpłat</label>
                       <div class="relative mt-1"><input type="number" id="limitAmount" placeholder="1000.00" class="block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500 sm:text-lg p-3 pr-16"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400">USDC</span></div>
                       <p class="text-xs text-gray-500 mt-2">Ustawiasz maksymalną kwotę USDC, którą kontrakt może pobrać z Twojego portfela. Możesz ustawić wyższy limit, aby uniknąć zatwierdzania każdej transakcji.</p>
                   </div>
                   <button id="approveButton" class="btn btn-blue">Ustaw Limit</button>
               </div>
           </div>
           <div class="bg-gray-800 p-8 rounded-xl">
               <h2 class="text-2xl font-bold mb-4 text-white">Wypłata</h2>
               <div class="flex border-b border-gray-700 mb-6"><button id="tabInstant" class="tab-active flex-1 py-2 text-center font-semibold transition-colors duration-300 rounded-t-md">Natychmiastowa</button><button id="tabDelayed" class="tab-inactive flex-1 py-2 text-center font-semibold transition-colors duration-300 rounded-t-md">Opóźniona</button></div>
               <div id="instantWithdrawPanel">
                   <p class="text-sm text-gray-400 mb-4">Wypłać natychmiastowo z opłatą <span id="feeInfo">...</span>%.</p>
                   <div class="space-y-4">
                       <div>
                           <label for="instantWithdrawAmount" class="block text-sm font-medium text-gray-400">Liczba udziałów Rcoin do sprzedania</label>
                           <div class="relative mt-1"><input type="number" id="instantWithdrawAmount" placeholder="0.00" class="block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500 sm:text-lg p-3 pr-20"><button id="instantMaxButton" class="absolute inset-y-0 right-0 mr-1 my-1 px-3 text-xs font-bold text-blue-300 bg-gray-600 hover:bg-gray-500 rounded-md border border-gray-500">MAX</button></div>
                       </div>
                       <button id="instantWithdrawButton" class="btn btn-red">Wypłać Natychmiast</button>
                   </div>
               </div>
               <div id="delayedWithdrawPanel" class="hidden">
                   <div id="requestSection">
                       <p class="text-sm text-gray-400 mb-4">Złóż wniosek o wypłatę bez opłat. Środki będą dostępne po <span id="delayInfo">...</span>.</p>
                       <div>
                           <label for="delayedWithdrawAmount" class="block text-sm font-medium text-gray-400">Liczba udziałów Rcoin do sprzedania</label>
                           <div class="relative mt-1"><input type="number" id="delayedWithdrawAmount" placeholder="0.00" class="block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-blue-500 focus:border-blue-500 sm:text-lg p-3 pr-20"><button id="delayedMaxButton" class="absolute inset-y-0 right-0 mr-1 my-1 px-3 text-xs font-bold text-blue-300 bg-gray-600 hover:bg-gray-500 rounded-md border border-gray-500">MAX</button></div>
                       </div>
                       <button id="requestDelayedWithdrawButton" class="mt-4 btn btn-blue">Złóż Wniosek</button>
                   </div>
                   <div id="manageSection" class="hidden text-center">
                       <p class="text-lg text-gray-300 mb-2">Masz aktywny wniosek o wypłatę:</p>
                       <p class="text-3xl font-bold text-white mb-4"><span id="pendingAmount">0.00</span> USDC</p>
                       <p id="unlockTime" class="font-semibold mb-6">...</p>
                       <div class="space-y-3"><button id="fulfillDelayedWithdrawButton" disabled class="btn btn-blue disabled:bg-gray-500 disabled:cursor-not-allowed">Odbierz Środki</button><button id="cancelDelayedWithdrawButton" class="btn btn-blue">Anuluj Wniosek</button></div>
                   </div>
               </div>
           </div>
       </section>
       <section id="fundManagerSection" class="mt-8 bg-gray-800/50 border border-blue-500/30 p-8 rounded-xl hidden">
           <h2 class="text-2xl font-bold mb-6 text-blue-300">Panel Menedżera Funduszu</h2>
           <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Wartość Funduszu (TVL)</h3><p id="tvl" class="text-2xl font-semibold text-white mt-1">...</p></div><div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Saldo On-Chain (w skarbcu)</h3><p id="onChainBalanceDisplay" class="text-2xl font-semibold text-white mt-1">...</p></div><div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-sm font-medium text-gray-400">Saldo Off-Chain</h3><p id="offChainBalanceDisplay" class="text-2xl font-semibold text-white mt-1">...</p></div></div>
           <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8"><div class="space-y-4"><label for="transferToManagerAmount" class="block text-sm font-medium text-gray-400">Transferuj do zarządzania (off-chain)</label><input type="number" id="transferToManagerAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white p-3"><button id="transferToManagerButton" class="btn btn-blue">Transferuj USDC</button></div><div class="space-y-4"><label for="transferToVaultAmount" class="block text-sm font-medium text-gray-400">Zwróć środki do skarbca</label><input type="number" id="transferToVaultAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white p-3"><button id="transferToVaultButton" class="btn btn-blue">Zwróć USDC</button></div><div class="space-y-4"><label for="offChainValueAmount" class="block text-sm font-medium text-gray-400">Zaktualizuj wartość aktywów off-chain</label><input type="number" id="offChainValueAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white p-3"><button id="updateOffChainValueButton" class="btn btn-blue">Aktualizuj Wartość</button></div></div>
           <div id="withdrawalRequestsHistory"><h3 class="text-xl font-bold mb-4 text-white">Historia Wniosków o Wypłatę (ostatnie 90 dni)</h3><div id="unclaimedRequestsContainer" class="mb-6"><h4 class="text-lg font-semibold mb-3 text-blue-300 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>Nieodebrane (Gotowe do wypłaty)</h4><div class="bg-gray-800 p-4 rounded-lg max-h-60 overflow-y-auto"><ul id="unclaimedRequestsList" class="space-y-3"></ul></div></div><div id="pendingRequestsContainer" class="mb-6"><h4 class="text-lg font-semibold mb-3 text-blue-300">Oczekujące</h4><div class="bg-gray-800 p-4 rounded-lg max-h-60 overflow-y-auto"><ul id="pendingRequestsList" class="space-y-3"></ul></div></div><div id="archivedRequestsContainer"><h4 class="text-lg font-semibold mb-3 text-gray-400">Zakończone (Wypłacone / Anulowane)</h4><div class="bg-gray-800 p-4 rounded-lg max-h-60 overflow-y-auto"><ul id="archivedRequestsList" class="space-y-3"></ul></div></div></div>
       </section>
   </main>

   <div id="statusMessage" class="fixed bottom-5 right-5 bg-gray-800 border-l-4 p-4 rounded-lg shadow-lg max-w-sm hidden">
       <div class="flex items-center"><div id="statusSpinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-3"></div><p id="statusText" class="text-white"></p></div>
   </div>
</div>

<script type="module">
// ZMIANA: Zmiana na "module" jest potrzebna dla Web3Modal
document.addEventListener('DOMContentLoaded', () => {
   const dApp = {
       // ZMIANA: Usunięto starą konfigurację kontraktów i sieci
       
       state: {
           provider: null, signer: null, userAddress: null, fundManagerAddress: null,
           contracts: { vault: null, usdc: null },
           rawRcoinBalance: null,
           web3Modal: null // Dodano pole na instancję Web3Modal
       },
       
       elements: {},

       // ZMIANA: Nowa, scentralizowana konfiguracja
       config: {
           contracts: {
               vault: "0xBbD6c7182264575072cB0CB4D66EA23c9390f08E",
               usdc: "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"
           },
           // -- Konfiguracja Web3Modal --
           web3ModalConfig: {
               projectId: '533deea06a33eab26d8da2235b5b0709', // <--- WAŻNE: Wklej tutaj swój Project ID!
               chains: [137], // ID Sieci Polygon Mainnet
               metadata: {
                   name: 'Rcoin Fund dApp',
                   description: 'dApp do zarządzania funduszem Rcoin',
                   url: 'https://rcoinfund.github.io', // Zmień na właściwy URL
                   icons: ['https://avatars.githubusercontent.com/u/37784886'] // Zmień na URL logo
               }
           }
       },

       async init() {
           const ids = [ "connectButton", "dappInterface", "rcoinBalance", "usdcBalance", "exchangeRate", "tvl", "approveButton", "depositButton", "depositAmount", "limitAmount", "allowanceInfo", "toggleLimitButton", "depositActionSection", "setLimitSection", "instantWithdrawAmount", "instantWithdrawButton", "delayedWithdrawAmount", "requestDelayedWithdrawButton", "fulfillDelayedWithdrawButton", "cancelDelayedWithdrawButton", "tabInstant", "tabDelayed", "instantWithdrawPanel", "delayedWithdrawPanel", "requestSection", "manageSection", "pendingAmount", "unlockTime", "feeInfo", "delayInfo", "fundManagerSection", "transferToManagerAmount", "transferToManagerButton", "transferToVaultAmount", "transferToVaultButton", "offChainValueAmount", "updateOffChainValueButton", "statusMessage", "statusText", "statusSpinner", "offChainBalanceDisplay", "onChainBalanceDisplay", "withdrawalRequestsHistory", "unclaimedRequestsContainer", "unclaimedRequestsList", "pendingRequestsContainer", "pendingRequestsList", "archivedRequestsContainer", "archivedRequestsList", "instantMaxButton", "delayedMaxButton" ];
           ids.forEach(id => this.elements[id] = document.getElementById(id));
           
           this.createWeb3Modal();
           this.setupEventListeners();
           this.subscribeProvider();
       },
       
       createWeb3Modal() {
           const { projectId, chains, metadata } = this.config.web3ModalConfig;
           const { Ethers5, Web3Modal } = window.Web3ModalEthers;
           
           this.state.web3Modal = new Web3Modal({ projectId, chains, metadata }, Ethers5);
       },

       // ZMIANA: Logika połączenia i nasłuchiwania zdarzeń scentralizowana tutaj
       subscribeProvider() {
           this.state.web3Modal.subscribeProvider(async ({ provider, address, chainId, isConnected }) => {
               if (isConnected && address && chainId === this.config.web3ModalConfig.chains[0]) {
                   this.state.userAddress = address;
                   this.elements.connectButton.innerText = `${address.substring(0, 6)}...${address.substring(38)}`;
                   this.elements.dappInterface.classList.remove('hidden');
                   await this.initializeContracts();
                   await this.startApp();
               } else {
                   this.state.userAddress = null;
                   this.elements.dappInterface.classList.add('hidden');
                   this.elements.connectButton.innerText = "Połącz Portfel";
               }
           });
       },

       setupEventListeners() {
           this.elements.connectButton.addEventListener('click', () => this.state.web3Modal.open());
           // ... reszta event listenerów bez zmian ...
           this.elements.approveButton.addEventListener('click', () => this.handleSetLimit()); this.elements.depositButton.addEventListener('click', () => this.handleDeposit()); this.elements.toggleLimitButton.addEventListener('click', () => { const isEditorHidden = this.elements.setLimitSection.classList.contains('hidden'); this.toggleLimitEditor(isEditorHidden); }); this.elements.instantWithdrawButton.addEventListener('click', () => this.handleInstantWithdraw()); this.elements.requestDelayedWithdrawButton.addEventListener('click', () => this.handleRequestDelayedWithdraw()); this.elements.fulfillDelayedWithdrawButton.addEventListener('click', () => this.handleFulfillDelayedWithdraw()); this.elements.cancelDelayedWithdrawButton.addEventListener('click', () => this.handleCancelDelayedWithdraw()); this.elements.tabInstant.addEventListener('click', () => this.switchTab('instant')); this.elements.tabDelayed.addEventListener('click', () => this.switchTab('delayed')); this.elements.transferToManagerButton.addEventListener('click', () => this.handleTransferToManager()); this.elements.transferToVaultButton.addEventListener('click', () => this.handleTransferToVault()); this.elements.updateOffChainValueButton.addEventListener('click', () => this.handleUpdateOffChainValue()); this.elements.instantMaxButton.addEventListener('click', () => this.handleMaxWithdraw('instant')); this.elements.delayedMaxButton.addEventListener('click', () => this.handleMaxWithdraw('delayed')); this.elements.withdrawalRequestsHistory.addEventListener('click', (e) => { if (e.target.dataset.action === 'fulfill' && e.target.dataset.user) { this.handleManagerFulfillWithdrawal(e.target.dataset.user); } });
       },
       
       // ZMIANA: Usunięto stare funkcje connectWallet, checkNetwork, handleAccountsChanged
       
       // ZMIANA: Inicjalizacja kontraktów pobiera provider z Web3Modal
       async initializeContracts() {
           const walletProvider = await this.state.web3Modal.getWalletProvider();
           if (!walletProvider) throw new Error("Wallet provider not found");
           this.state.provider = new ethers.providers.Web3Provider(walletProvider);
           this.state.signer = this.state.provider.getSigner();

           const vaultABI = [{"inputs":[{"internalType":"address","name":"_fundManager","type":"address"},{"internalType":"address","name":"_feeRecipient","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"ERC4626ExceededMaxTotalAssets","type":"error"},{"inputs":[],"name":"ERC4626InvalidReceiver","type":"error"},{"inputs":[],"name":"ERC4626InvalidSender","type":"error"},{"inputs":[],"name":"ERC4626InvalidShares","type":"error"},{"inputs":[],"name":"ERC4626ZeroAssets","type":"error"},{"inputs":[],"name":"ERC4626ZeroShares","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"AssetsTransferredToManager","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"AssetsTransferredToVault","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"DelayedWithdrawalCanceled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"fulfiller","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsRedeemed","type":"uint256"}],"name":"DelayedWithdrawalFulfilled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsToRedeem","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"unlockTime","type":"uint256"}],"name":"DelayedWithdrawalRequested","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"caller","type":"address"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"assets","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shares","type":"uint256"}],"name":"Deposit","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldRecipient","type":"address"},{"indexed":true,"internalType":"address","name":"newRecipient","type":"address"}],"name":"FeeRecipientUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"newFeeBps","type":"uint16"}],"name":"InstantWithdrawalFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsRedeemed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"feeAmount","type":"uint256"}],"name":"InstantWithdrawal","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newBalance","type":"uint256"}],"name":"OffChainBalanceUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newTotalValue","type":"uint256"}],"name":"OffChainAssetValueUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"assets","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shares","type":"uint256"}],"name":"Withdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newDelay","type":"uint256"}],"name":"WithdrawalDelayUpdated","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"asset","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"cancelDelayedWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"convertToAssets","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"name":"convertToShares","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"}],"name":"deposit","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeRecipient","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"client","type":"address"}],"name":"fulfillDelayedWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"fundManager","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getExchangeRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getOffChainBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToRedeem","type":"uint256"}],"name":"instantWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"instantWithdrawalFeeBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"maxRedeem","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"maxWithdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"}],"name":"mint","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"name":"previewDeposit","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"previewMint","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"previewRedeem","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"name":"previewWithdraw","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"redeem","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToRedeem","type":"uint256"}],"name":"requestDelayedWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newFeeRecipient","type":"address"}],"name":"setFeeRecipient","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newFundManager","type":"address"}],"name":"setFundManager","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_newFeeBps","type":"uint16"}],"name":"setInstantWithdrawalFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newDelay","type":"uint256"}],"name":"setWithdrawalDelay","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalAssets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToTransfer","type":"uint256"}],"name":"transferAssetsToFundManager","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToTransfer","type":"uint256"}],"name":"transferAssetsToVault","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newTotalValue","type":"uint256"}],"name":"updateOffChainAssetValue","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"withdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawalDelayPeriod","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"withdrawalRequests","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];
           const usdcABI = [{"inputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"symbol","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
           
           this.state.contracts.vault = new ethers.Contract(this.config.contracts.vault, vaultABI, this.state.signer);
           this.state.contracts.usdc = new ethers.Contract(this.config.contracts.usdc, usdcABI, this.state.signer);
       },

       async startApp() { /* ... bez zmian ... */ this.state.fundManagerAddress = await this.state.contracts.vault.fundManager(); await this.updateUI(); },
       async updateUI() { /* ... bez zmian, ale z poprawką na saldo Rcoin ... */ if (!this.state.userAddress || !this.state.contracts.vault) return; const rcoinBal = await this.state.contracts.vault.balanceOf(this.state.userAddress); this.state.rawRcoinBalance = rcoinBal; const usdcBal = await this.state.contracts.usdc.balanceOf(this.state.userAddress); const exchangeRate = await this.state.contracts.vault.getExchangeRate(); const feeBps = await this.state.contracts.vault.instantWithdrawalFeeBps(); const delay = await this.state.contracts.vault.withdrawalDelayPeriod(); const allowance = await this.state.contracts.usdc.allowance(this.state.userAddress, this.config.contracts.vault); const formattedExchangeRate = parseFloat(ethers.utils.formatUnits(exchangeRate, 18)).toFixed(2); this.elements.rcoinBalance.innerText = `${parseFloat(ethers.utils.formatUnits(rcoinBal, 6)).toFixed(2)} RCOIN`; this.elements.usdcBalance.innerText = `${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC`; this.elements.exchangeRate.innerText = `1 RCOIN = ${formattedExchangeRate} USDC`; this.elements.feeInfo.innerText = (feeBps / 100).toFixed(2); this.elements.delayInfo.innerText = `${this.formatDuration(delay.toNumber())}`; this.elements.allowanceInfo.innerText = `${parseFloat(ethers.utils.formatUnits(allowance, 6)).toFixed(2)} USDC`; if (allowance.lt(ethers.utils.parseUnits("1", 6))) this.toggleLimitEditor(true); else this.toggleLimitEditor(false); const request = await this.state.contracts.vault.withdrawalRequests(this.state.userAddress); if (request.timestamp.gt(0)) { this.elements.requestSection.classList.add('hidden'); this.elements.manageSection.classList.remove('hidden'); this.elements.pendingAmount.innerText = parseFloat(ethers.utils.formatUnits(request.assets, 6)).toFixed(2); const unlockTimestamp = request.timestamp.add(delay).toNumber(); const now = Math.floor(Date.now() / 1000); this.elements.unlockTime.innerText = `Dostępne za: ${this.formatRemainingTime(unlockTimestamp)}`; this.elements.fulfillDelayedWithdrawButton.disabled = now < unlockTimestamp; } else { this.elements.requestSection.classList.remove('hidden'); this.elements.manageSection.classList.add('hidden'); } if (this.state.userAddress.toLowerCase() === this.state.fundManagerAddress.toLowerCase()) { this.elements.fundManagerSection.classList.remove('hidden'); const tvl = await this.state.contracts.vault.totalAssets(); const offChainBalance = await this.state.contracts.vault.getOffChainBalance(); const onChainBalance = await this.state.contracts.usdc.balanceOf(this.config.contracts.vault); this.elements.tvl.innerText = `${parseFloat(ethers.utils.formatUnits(tvl, 6)).toFixed(2)} USDC`; this.elements.onChainBalanceDisplay.innerText = `${parseFloat(ethers.utils.formatUnits(onChainBalance, 6)).toFixed(2)} USDC`; this.elements.offChainBalanceDisplay.innerText = `${parseFloat(ethers.utils.formatUnits(offChainBalance, 6)).toFixed(2)} USDC`; await this.loadPendingWithdrawals(); } else { this.elements.fundManagerSection.classList.add('hidden'); } },
       async loadPendingWithdrawals() { /* ... bez zmian ... */ if (!this.state.provider || !this.state.contracts.vault) return; this.showStatus("Ładowanie historii wniosków...", "loading"); const lists = { unclaimed: this.elements.unclaimedRequestsList, pending: this.elements.pendingRequestsList, archived: this.elements.archivedRequestsList }; Object.values(lists).forEach(list => list.innerHTML = '<li>Trwa ładowanie...</li>'); try { const currentDelayPeriod = await this.state.contracts.vault.withdrawalDelayPeriod(); const currentBlockNum = await this.state.provider.getBlockNumber(); const blocksPerDay = (24 * 60 * 60) / 3; const fromBlock = Math.max(0, currentBlockNum - (blocksPerDay * 90)); const requestFilter = this.state.contracts.vault.filters.DelayedWithdrawalRequested(); const cancelFilter = this.state.contracts.vault.filters.DelayedWithdrawalCanceled(); const fulfillFilter = this.state.contracts.vault.filters.DelayedWithdrawalFulfilled(); const [requestEvents, cancelEvents, fulfillEvents] = await Promise.all([ this.state.contracts.vault.queryFilter(requestFilter, fromBlock, 'latest'), this.state.contracts.vault.queryFilter(cancelFilter, fromBlock, 'latest'), this.state.contracts.vault.queryFilter(fulfillFilter, fromBlock, 'latest') ]); const allEvents = [...requestEvents, ...cancelEvents, ...fulfillEvents]; allEvents.sort((a, b) => { if (a.blockNumber !== b.blockNumber) return a.blockNumber - b.blockNumber; return a.transactionIndex - b.transactionIndex; }); const blockNumbers = requestEvents.map(e => e.blockNumber); const uniqueBlockNumbers = [...new Set(blockNumbers)]; const blockPromises = uniqueBlockNumbers.map(num => this.state.provider.getBlock(num)); const blocks = await Promise.all(blockPromises); const blockTimestamps = blocks.reduce((acc, block) => { acc[block.number] = block.timestamp; return acc; }, {}); const requestsMap = new Map(); const activeRequestKeyForUser = new Map(); for (const event of allEvents) { const user = event.args.user.toLowerCase(); switch (event.event) { case 'DelayedWithdrawalRequested': { const uniqueKey = `${user}-${event.transactionHash}`; requestsMap.set(uniqueKey, { user: event.args.user, assets: event.args.assetsToRedeem, creationTimestamp: blockTimestamps[event.blockNumber], status: 'pending', event: event }); activeRequestKeyForUser.set(user, uniqueKey); break; } case 'DelayedWithdrawalCanceled': { const activeKey = activeRequestKeyForUser.get(user); if (activeKey && requestsMap.has(activeKey)) { requestsMap.get(activeKey).status = 'canceled'; activeRequestKeyForUser.delete(user); } break; } case 'DelayedWithdrawalFulfilled': { const activeKey = activeRequestKeyForUser.get(user); if (activeKey && requestsMap.has(activeKey)) { requestsMap.get(activeKey).status = 'fulfilled'; activeRequestKeyForUser.delete(user); } break; } } } Object.values(lists).forEach(list => list.innerHTML = ''); const now = Math.floor(Date.now() / 1000); const finalRequests = Array.from(requestsMap.values()).sort((a,b) => b.event.blockNumber - a.event.blockNumber); finalRequests.forEach(req => { let targetList; const actualUnlockTime = req.creationTimestamp + currentDelayPeriod.toNumber(); const isReady = actualUnlockTime <= now; if (req.status === 'pending') { if (isReady) { req.status = 'ready'; targetList = lists.unclaimed; } else { targetList = lists.pending; } } else { targetList = lists.archived; } targetList.appendChild(this.createRequestListItem(req, actualUnlockTime)); }); Object.values(lists).forEach((list, index) => { if (list.children.length === 0) { const message = ['Brak wniosków do odbioru.', 'Brak oczekujących wniosków.', 'Brak zakończonych wniosków.'][index]; list.innerHTML = `<li class="text-gray-500 text-center py-2">${message}</li>`; } }); this.hideStatus(); } catch (error) { console.error("Błąd podczas pobierania historii wniosków:", error); this.showStatus("Błąd ładowania historii", "error"); Object.values(lists).forEach(list => list.innerHTML = '<li>Wystąpił błąd podczas ładowania.</li>'); } },
       createRequestListItem(req, unlockTime) { /* ... bez zmian ... */ const li = document.createElement('li'); const now = Math.floor(Date.now() / 1000); let statusText, statusColorClass, controls = ''; switch(req.status) { case 'ready': statusText = `Gotowe do odbioru (opóźnienie ${this.formatDuration(now - unlockTime)})`; statusColorClass = 'text-green-400'; controls = `<button data-action="fulfill" data-user="${req.user}" class="btn btn-blue text-xs py-1 px-2 w-auto">Wypłać w imieniu klienta</button>`; li.className = 'text-sm p-3 bg-gray-700 rounded-md flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2'; break; case 'pending': statusText = `Pozostało: ${this.formatRemainingTime(unlockTime)}`; statusColorClass = 'text-blue-300'; li.className = 'text-sm p-3 bg-gray-700/50 rounded-md flex justify-between items-center'; break; case 'fulfilled': statusText = 'Wypłacono'; statusColorClass = 'text-green-400'; li.className = 'text-sm p-3 bg-gray-900/50 rounded-md flex justify-between items-center opacity-60'; break; case 'canceled': statusText = 'Anulowano'; statusColorClass = 'text-red-400'; li.className = 'text-sm p-3 bg-gray-900/50 rounded-md flex justify-between items-center opacity-60'; break; } const formattedAssets = parseFloat(ethers.utils.formatUnits(req.assets, 6)).toFixed(2); li.innerHTML = ` <div class="flex-grow"> <p class="font-mono text-xs text-gray-400">${req.user}</p> <p class="font-semibold text-white ${req.status === 'canceled' ? 'line-through text-gray-500' : ''}">${formattedAssets} USDC</p> </div> <div class="text-left sm:text-right w-full sm:w-auto mt-2 sm:mt-0"> <p class="font-medium ${statusColorClass} text-xs mb-1">${statusText}</p> ${controls} </div> `; return li; },
       async handleTransaction(action, successMessage, errorMessage) { /* ... bez zmian ... */ this.showStatus("Oczekiwanie na potwierdzenie...", "loading"); try { const tx = await action(); this.showStatus("Przetwarzanie transakcji...", "loading"); await tx.wait(); this.showStatus(successMessage, "success"); await this.updateUI(); } catch (error) { console.error(errorMessage, error); this.showStatus(error.reason || errorMessage, "error"); } },
       handleMaxWithdraw(type) { if (!this.state.rawRcoinBalance) return; const fullAmount = ethers.utils.formatUnits(this.state.rawRcoinBalance, 6); if (type === 'instant') { this.elements.instantWithdrawAmount.value = fullAmount; } else { this.elements.delayedWithdrawAmount.value = fullAmount; } },
       async handleSetLimit() { const amount = this.elements.limitAmount.value; if (!amount || amount <= 0) return this.showStatus("Wprowadź poprawną kwotę limitu", "error"); const amountWei = ethers.utils.parseUnits(amount, 6); await this.handleTransaction(() => this.state.contracts.usdc.approve(this.config.contracts.vault, amountWei), "Limit wpłat zaktualizowany!", "Błąd ustawiania limitu"); },
       async handleDeposit() { const amount = this.elements.depositAmount.value; if (!amount || amount <= 0) return this.showStatus("Wprowadź poprawną kwotę", "error"); const allowance = await this.state.contracts.usdc.allowance(this.state.userAddress, this.config.contracts.vault); const amountWei = ethers.utils.parseUnits(amount, 6); if (amountWei.gt(allowance)) return this.showStatus("Kwota wpłaty przekracza ustawiony limit. Zwiększ go.", "error"); await this.handleTransaction(() => this.state.contracts.vault.deposit(amountWei, this.state.userAddress), "Wpłata udana!", "Błąd wpłaty"); },
       async handleInstantWithdraw() { const rcoinAmount = this.elements.instantWithdrawAmount.value; if (!rcoinAmount || rcoinAmount <= 0) return this.showStatus("Wprowadź poprawną liczbę udziałów", "error"); const sharesToRedeem = ethers.utils.parseUnits(rcoinAmount, 6); this.showStatus("Przeliczanie udziałów na USDC...", "loading"); try { const assetsToRedeem = await this.state.contracts.vault.convertToAssets(sharesToRedeem); await this.handleTransaction(() => this.state.contracts.vault.instantWithdrawal(assetsToRedeem),"Wypłata natychmiastowa udana!","Błąd wypłaty natychmiastowej"); } catch (error) { console.error("Błąd przeliczania udziałów:", error); this.showStatus("Błąd przeliczania udziałów", "error"); } },
       async handleRequestDelayedWithdraw() { const rcoinAmount = this.elements.delayedWithdrawAmount.value; if (!rcoinAmount || rcoinAmount <= 0) return this.showStatus("Wprowadź poprawną liczbę udziałów", "error"); const sharesToRequest = ethers.utils.parseUnits(rcoinAmount, 6); this.showStatus("Przeliczanie udziałów na USDC...", "loading"); try { const assetsToRequest = await this.state.contracts.vault.convertToAssets(sharesToRequest); await this.handleTransaction(() => this.state.contracts.vault.requestDelayedWithdrawal(assetsToRequest),"Wniosek o wypłatę złożony!","Błąd składania wniosku"); } catch (error) { console.error("Błąd przeliczania udziałów:", error); this.showStatus("Błąd przeliczania udziałów", "error"); } },
       async handleFulfillDelayedWithdraw() { await this.handleTransaction(() => this.state.contracts.vault.fulfillDelayedWithdrawal(this.state.userAddress), "Środki zostały odebrane!", "Błąd odbioru środków"); },
       async handleCancelDelayedWithdraw() { await this.handleTransaction(() => this.state.contracts.vault.cancelDelayedWithdrawal(), "Wniosek został anulowany!", "Błąd anulowania wniosku"); },
       async handleManagerFulfillWithdrawal(clientAddress) { await this.handleTransaction(() => this.state.contracts.vault.fulfillDelayedWithdrawal(clientAddress), `Wypłata dla ${clientAddress.substring(0,6)}... zrealizowana!`, "Błąd realizacji wypłaty"); },
       async handleTransferToManager() { const amount = this.elements.transferToManagerAmount.value; if (!amount || amount <= 0) return this.showStatus("Wprowadź poprawną kwotę", "error"); const amountWei = ethers.utils.parseUnits(amount, 6); await this.handleTransaction(() => this.state.contracts.vault.transferAssetsToFundManager(amountWei), "Transfer do managera udany!", "Błąd transferu do managera"); },
       async handleTransferToVault() { const amount = this.elements.transferToVaultAmount.value; if (!amount || amount <= 0) return this.showStatus("Wprowadź poprawną kwotę", "error"); const amountWei = ethers.utils.parseUnits(amount, 6); this.showStatus("Zatwierdź USDC do transferu...", "info"); const approveTx = await this.state.contracts.usdc.approve(this.config.contracts.vault, amountWei); await approveTx.wait(); this.showStatus("Zatwierdzono. Przetwarzanie transferu...", "loading"); await this.handleTransaction(() => this.state.contracts.vault.transferAssetsToVault(amountWei), "Zwrot środków do skarbca udany!", "Błąd zwrotu środków"); },
       async handleUpdateOffChainValue() { const amount = this.elements.offChainValueAmount.value; if (!amount || amount < 0) return this.showStatus("Wprowadź poprawną kwotę", "error"); const amountWei = ethers.utils.parseUnits(amount, 6); await this.handleTransaction(() => this.state.contracts.vault.updateOffChainAssetValue(amountWei), "Wartość aktywów off-chain zaktualizowana!", "Błąd aktualizacji wartości"); },
       
       toggleLimitEditor(showEditor) { if (showEditor) { this.elements.depositActionSection.classList.add('hidden'); this.elements.setLimitSection.classList.remove('hidden'); this.elements.toggleLimitButton.innerText = 'ANULUJ'; } else { this.elements.depositActionSection.classList.remove('hidden'); this.elements.setLimitSection.classList.add('hidden'); this.elements.toggleLimitButton.innerText = 'ZMIEŃ'; } },
       formatDuration(totalSeconds) { if (totalSeconds < 0) totalSeconds = 0; const days = Math.floor(totalSeconds / 86400); totalSeconds %= 86400; const hours = Math.floor(totalSeconds / 3600); totalSeconds %= 3600; const minutes = Math.floor(totalSeconds / 60); let parts = []; if (days > 0) parts.push(`${days}d`); if (hours > 0) parts.push(`${hours}h`); if (minutes > 0) parts.push(`${minutes}m`); return parts.length > 0 ? parts.join(' ') : '<1m'; },
       formatRemainingTime(unlockTimestamp) { const now = Math.floor(Date.now() / 1000); let secondsRemaining = unlockTimestamp - now; if (secondsRemaining <= 0) return "Dostępne"; return this.formatDuration(secondsRemaining); },
       switchTab(tab) { if (tab === 'instant') { this.elements.tabInstant.classList.replace('tab-inactive', 'tab-active'); this.elements.tabDelayed.classList.replace('tab-active', 'tab-inactive'); this.elements.instantWithdrawPanel.classList.remove('hidden'); this.elements.delayedWithdrawPanel.classList.add('hidden'); } else { this.elements.tabInstant.classList.replace('tab-active', 'tab-inactive'); this.elements.tabDelayed.classList.replace('tab-inactive', 'tab-active'); this.elements.instantWithdrawPanel.classList.add('hidden'); this.elements.delayedWithdrawPanel.classList.remove('hidden'); } },
       showStatus(message, type = "info") { this.elements.statusText.innerText = message; const statusDiv = this.elements.statusMessage; statusDiv.classList.remove('hidden'); statusDiv.className = 'fixed bottom-5 right-5 p-4 rounded-lg shadow-lg max-w-sm border-l-4'; if (type === 'loading') { this.elements.statusSpinner.classList.remove('hidden'); statusDiv.classList.add('bg-blue-900', 'border-blue-500'); } else { this.elements.statusSpinner.classList.add('hidden'); if (type === 'success') statusDiv.classList.add('bg-green-900', 'border-green-500'); else if (type === 'error') statusDiv.classList.add('bg-red-900', 'border-red-500'); else statusDiv.classList.add('bg-gray-800', 'border-gray-500'); setTimeout(() => this.hideStatus(), 5000); } },
       hideStatus() { this.elements.statusMessage.classList.add('hidden'); },
   };

   dApp.init();
});
</script>
</body>
</html>
