<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rcoin Fund dApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .tab-active {
            background-color: #4f46e5;
            color: white;
        }
        .tab-inactive {
            background-color: #374151;
            color: #d1d5db;
        }
        .loader {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-white">Rcoin Fund</h1>
            <button id="connectButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                Połącz Portfel
            </button>
        </header>

        <main id="dappInterface" class="hidden">
            <!-- Dashboard -->
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-400">Twoje Saldo Rcoin</h3>
                    <p id="rcoinBalance" class="text-2xl font-semibold text-white mt-1">0.00</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-400">Twoje Saldo USDC</h3>
                    <p id="usdcBalance" class="text-2xl font-semibold text-white mt-1">0.00</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-400">Kurs Rcoin</h3>
                    <p id="exchangeRate" class="text-2xl font-semibold text-white mt-1">1.00 USDC</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-400">Wartość Funduszu (TVL)</h3>
                    <p id="tvl" class="text-2xl font-semibold text-white mt-1">0.00 USDC</p>
                </div>
            </section>

            <!-- Actions -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Deposit -->
                <div class="bg-gray-800 p-8 rounded-xl">
                    <h2 class="text-2xl font-bold mb-6 text-white">Wpłata USDC</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="depositAmount" class="block text-sm font-medium text-gray-400">Kwota</label>
                            <input type="number" id="depositAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg p-3">
                        </div>
                        <div class="flex space-x-4">
                            <button id="approveButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">1. Zatwierdź</button>
                            <button id="depositButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">2. Wpłać</button>
                        </div>
                    </div>
                </div>

                <!-- Withdraw -->
                <div class="bg-gray-800 p-8 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-white">Wypłata</h2>
                    <div class="flex border-b border-gray-700 mb-6">
                        <button id="tabInstant" class="tab-active flex-1 py-2 text-center font-semibold transition-colors duration-300 rounded-t-md">Natychmiastowa</button>
                        <button id="tabDelayed" class="tab-inactive flex-1 py-2 text-center font-semibold transition-colors duration-300 rounded-t-md">Opóźniona</button>
                    </div>

                    <!-- Instant Withdraw Panel -->
                    <div id="instantWithdrawPanel">
                        <p class="text-sm text-gray-400 mb-4">Wypłać natychmiastowo z opłatą <span id="feeInfo">10</span>%.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="instantWithdrawAmount" class="block text-sm font-medium text-gray-400">Kwota USDC do wypłaty</label>
                                <input type="number" id="instantWithdrawAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg p-3">
                            </div>
                            <button id="instantWithdrawButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Wypłać Natychmiast</button>
                        </div>
                    </div>

                    <!-- Delayed Withdraw Panel -->
                    <div id="delayedWithdrawPanel" class="hidden">
                        <div id="requestSection">
                            <p class="text-sm text-gray-400 mb-4">Złóż wniosek o wypłatę bez opłat. Środki będą dostępne po <span id="delayInfo">7</span> dniach.</p>
                            <div>
                                <label for="delayedWithdrawAmount" class="block text-sm font-medium text-gray-400">Kwota USDC do wypłaty</label>
                                <input type="number" id="delayedWithdrawAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg p-3">
                            </div>
                            <button id="requestDelayedWithdrawButton" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Złóż Wniosek</button>
                        </div>
                        <div id="manageSection" class="hidden text-center">
                            <p class="text-lg text-gray-300 mb-2">Masz aktywny wniosek o wypłatę:</p>
                            <p class="text-3xl font-bold text-white mb-4"><span id="pendingAmount">0.00</span> USDC</p>
                            <p id="unlockTime" class="text-indigo-400 font-semibold mb-6">...</p>
                            <div class="space-y-3">
                                <button id="fulfillDelayedWithdrawButton" disabled class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed">Odbierz Środki</button>
                                <button id="cancelDelayedWithdrawButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Anuluj Wniosek</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Fund Manager Actions (Conditional) -->
            <section id="fundManagerSection" class="mt-8 bg-gray-800 p-8 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-4 text-white">Akcje Fund Managera</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Transfer to Manager -->
                    <div class="space-y-4">
                        <label for="transferToManagerAmount" class="block text-sm font-medium text-gray-400">Transfer środków do managera</label>
                        <input type="number" id="transferToManagerAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white p-3">
                        <button id="transferToManagerButton" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Przekaż do Managera</button>
                    </div>

                    <!-- Update Off-Chain Balance -->
                    <div class="space-y-4">
                        <label for="offChainBalanceAmount" class="block text-sm font-medium text-gray-400">Zaktualizuj Off-Chain Balance</label>
                        <input type="number" id="offChainBalanceAmount" placeholder="0.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white p-3">
                        <button id="updateOffChainBalanceButton" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Zaktualizuj Balance</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Status Message -->
        <div id="statusMessage" class="fixed bottom-5 right-5 bg-gray-800 border-l-4 p-4 rounded-lg shadow-lg max-w-sm hidden animate-pulse">
            <div class="flex items-center">
                <div id="statusSpinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-3"></div>
                <p id="statusText" class="text-white"></p>
            </div>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <script>
        // --- CONFIGURATION ---
        const vaultContractAddress = "0xfe203ef73b69c819796C3a3572609C29Dd0FaFFE";
        const usdcContractAddress = "0x41E94Eb019C0762f9Bfcf9Fb1E58725BfB0e7582"; 
        const desiredChainId = 80002; // ID sieci Polygon Amoy

        // --- ABIs ---
        const vaultABI = [
            {"inputs":[{"internalType":"address","name":"fundManager_","type":"address"},{"internalType":"address","name":"feeRecipient_","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[],"name":"ERC4626ExceededMaxTotalAssets","type":"error"},{"inputs":[],"name":"ERC4626InvalidReceiver","type":"error"},{"inputs":[],"name":"ERC4626InvalidSender","type":"error"},{"inputs":[],"name":"ERC4626InvalidShares","type":"error"},{"inputs":[],"name":"ERC4626ZeroAssets","type":"error"},{"inputs":[],"name":"ERC4626ZeroShares","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"AssetsTransferredToManager","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"AssetsTransferredToVault","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsToRedeem","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"unlockTime","type":"uint256"}],"name":"DelayedWithdrawalRequested","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"caller","type":"address"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"assets","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shares","type":"uint256"}],"name":"Deposit","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldRecipient","type":"address"},{"indexed":true,"internalType":"address","name":"newRecipient","type":"address"}],"name":"FeeRecipientUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"assetsRedeemed","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"feeAmount","type":"uint256"}],"name":"InstantWithdrawal","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newTotalValue","type":"uint256"}],"name":"OffChainAssetValueUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newBalance","type":"uint256"}],"name":"OffChainBalanceUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"assetsToTransfer","type":"uint256"}],"name":"AssetsTransferredToFundManager","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"assetsToTransfer","type":"uint256"}],"name":"AssetsTransferredToVault","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"asset","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"cancelDelayedWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"convertToAssets","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"name":"convertToShares","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"}],"name":"deposit","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feeRecipient","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"fulfillDelayedWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"fundManager","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getExchangeRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getOffChainBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToRedeem","type":"uint256"}],"name":"instantWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"instantWithdrawalFeeBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"maxDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"maxMint","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"maxRedeem","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"maxWithdraw","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"}],"name":"mint","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"name":"previewDeposit","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"previewMint","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"previewRedeem","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"}],"name":"previewWithdraw","outputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"redeem","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToRedeem","type":"uint256"}],"name":"requestDelayedWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newFeeRecipient","type":"address"}],"name":"setFeeRecipient","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newFundManager","type":"address"}],"name":"setFundManager","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"newFeeBps","type":"uint16"}],"name":"setInstantWithdrawalFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newDelay","type":"uint256"}],"name":"setWithdrawalDelay","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalAssets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assetsToTransfer","type":"uint256"}],"name":"transferAssetsToFundManager","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newTotalValue","type":"uint256"}],"name":"updateOffChainAssetValue","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"withdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawalDelayPeriod","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"withdrawalRequests","outputs":[{"internalType":"uint256","name":"assets","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];
        const usdcABI = [
            {"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"payable":true,"stateMutability":"payable","type":"fallback"}
        ];

        // --- Global Variables ---
        let provider, signer, userAddress, vaultContract, usdcContract, fundManagerAddress;

        // --- DOM Elements ---
        const connectButton = document.getElementById('connectButton');
        const dappInterface = document.getElementById('dappInterface');
        const rcoinBalanceEl = document.getElementById('rcoinBalance');
        const usdcBalanceEl = document.getElementById('usdcBalance');
        const exchangeRateEl = document.getElementById('exchangeRate');
        const tvlEl = document.getElementById('tvl');
        const approveButton = document.getElementById('approveButton');
        const depositButton = document.getElementById('depositButton');
        const depositAmountInput = document.getElementById('depositAmount');
        const instantWithdrawAmountInput = document.getElementById('instantWithdrawAmount');
        const instantWithdrawButton = document.getElementById('instantWithdrawButton');
        const delayedWithdrawAmountInput = document.getElementById('delayedWithdrawAmount');
        const requestDelayedWithdrawButton = document.getElementById('requestDelayedWithdrawButton');
        const fulfillDelayedWithdrawButton = document.getElementById('fulfillDelayedWithdrawButton');
        const cancelDelayedWithdrawButton = document.getElementById('cancelDelayedWithdrawButton');
        const tabInstant = document.getElementById('tabInstant');
        const tabDelayed = document.getElementById('tabDelayed');
        const instantWithdrawPanel = document.getElementById('instantWithdrawPanel');
        const delayedWithdrawPanel = document.getElementById('delayedWithdrawPanel');
        const requestSection = document.getElementById('requestSection');
        const manageSection = document.getElementById('manageSection');
        const pendingAmountEl = document.getElementById('pendingAmount');
        const unlockTimeEl = document.getElementById('unlockTime');
        const feeInfoEl = document.getElementById('feeInfo');
        const delayInfoEl = document.getElementById('delayInfo');
        const fundManagerSection = document.getElementById('fundManagerSection');
        const transferToManagerButton = document.getElementById('transferToManagerButton');
        const transferToManagerAmountInput = document.getElementById('transferToManagerAmount');
        const updateOffChainBalanceButton = document.getElementById('updateOffChainBalanceButton');
        const offChainBalanceAmountInput = document.getElementById('offChainBalanceAmount');
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');
        const statusSpinner = document.getElementById('statusSpinner');

        // --- Event Listeners ---
        window.addEventListener('load', async () => {
            connectButton.addEventListener('click', connectWallet);
            approveButton.addEventListener('click', handleApprove);
            depositButton.addEventListener('click', handleDeposit);
            instantWithdrawButton.addEventListener('click', handleInstantWithdraw);
            requestDelayedWithdrawButton.addEventListener('click', handleRequestDelayedWithdraw);
            fulfillDelayedWithdrawButton.addEventListener('click', handleFulfillDelayedWithdraw);
            cancelDelayedWithdrawButton.addEventListener('click', handleCancelDelayedWithdraw);
            tabInstant.addEventListener('click', () => switchTab('instant'));
            tabDelayed.addEventListener('click', () => switchTab('delayed'));
            transferToManagerButton.addEventListener('click', handleTransferToManager);
            updateOffChainBalanceButton.addEventListener('click', handleUpdateOffChainBalance);
            
            // Listen for changes in account and network
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        userAddress = accounts[0];
                        connectButton.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                        updateAllData();
                    } else {
                        dappInterface.classList.add('hidden');
                        connectButton.textContent = 'Połącz Portfel';
                    }
                });
                window.ethereum.on('chainChanged', (chainId) => {
                    window.location.reload();
                });
            }
        });

        // --- Functions ---
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showStatus("Proszę zainstalować MetaMask!", true, true);
                return;
            }

            try {
                // Request accounts and check if the user is on the correct network
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const currentChainId = parseInt(window.ethereum.chainId, 16);
                if (currentChainId !== desiredChainId) {
                    showStatus("Przełącz się na sieć Polygon Amoy!", true, false);
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: `0x${desiredChainId.toString(16)}` }],
                        });
                        // Wait for the chain to change and then reload
                        window.ethereum.on('chainChanged', () => window.location.reload());
                        return;
                    } catch (switchError) {
                        // This error indicates that the network is not available to switch
                        showStatus("Nie można przełączyć sieci. Dodaj Polygon Amoy do portfela.", true, false);
                        return;
                    }
                }

                // Get provider, signer and user address
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Initialize contracts
                vaultContract = new ethers.Contract(vaultContractAddress, vaultABI, signer);
                usdcContract = new ethers.Contract(usdcContractAddress, usdcABI, signer);
                fundManagerAddress = await vaultContract.fundManager();

                // Update UI
                dappInterface.classList.remove('hidden');
                connectButton.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;

                if (userAddress.toLowerCase() === fundManagerAddress.toLowerCase()) {
                    fundManagerSection.classList.remove('hidden');
                } else {
                    fundManagerSection.classList.add('hidden');
                }
                
                await updateAllData();

            } catch (error) {
                console.error("Błąd połączenia z portfelem:", error);
                showStatus("Błąd połączenia z portfelem", true);
            }
        }

        async function updateAllData() {
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (parseInt(chainId, 16) !== desiredChainId) {
                    showStatus("Proszę przełączyć na sieć Polygon Amoy", true);
                    return;
                }
            } catch (error) {
                console.error("Błąd sprawdzenia sieci:", error);
                showStatus("Błąd sprawdzenia sieci", true);
                return;
            }
            await updateDashboard();
            await updateDelayedWithdrawalStatus();
            await updateStaticInfo();
        }
        
        async function updateDashboard() {
            try {
                const rcoinBal = await vaultContract.balanceOf(userAddress);
                const usdcBal = await usdcContract.balanceOf(userAddress);
                const rate = await vaultContract.getExchangeRate();
                const totalAssets = await vaultContract.totalAssets();
                const usdcDecimals = await usdcContract.decimals();

                rcoinBalanceEl.textContent = parseFloat(ethers.utils.formatEther(rcoinBal)).toFixed(2);
                usdcBalanceEl.textContent = parseFloat(ethers.utils.formatUnits(usdcBal, usdcDecimals)).toFixed(2);
                exchangeRateEl.textContent = `${parseFloat(ethers.utils.formatEther(rate)).toFixed(4)} USDC`;
                tvlEl.textContent = `${parseFloat(ethers.utils.formatUnits(totalAssets, usdcDecimals)).toFixed(2)} USDC`;
            } catch (error) {
                console.error("Błąd odświeżania danych:", error);
                showStatus("Błąd odświeżania danych", true);
            }
        }

        async function updateDelayedWithdrawalStatus() {
            try {
                const request = await vaultContract.withdrawalRequests(userAddress);
                if (request.timestamp.gt(0)) {
                    requestSection.classList.add('hidden');
                    manageSection.classList.remove('hidden');
                    
                    const usdcDecimals = await usdcContract.decimals();
                    pendingAmountEl.textContent = ethers.utils.formatUnits(request.assets, usdcDecimals);

                    const delay = await vaultContract.withdrawalDelayPeriod();
                    const unlockTimestamp = request.timestamp.add(delay).toNumber();
                    const now = Math.floor(Date.now() / 1000);

                    if (now >= unlockTimestamp) {
                        unlockTimeEl.textContent = "Środki gotowe do odbioru!";
                        unlockTimeEl.classList.remove('text-indigo-400');
                        unlockTimeEl.classList.add('text-green-400');
                        fulfillDelayedWithdrawalButton.disabled = false;
                    } else {
                        const timeLeft = unlockTimestamp - now;
                        unlockTimeEl.textContent = `Dostępne za: ${formatTime(timeLeft)}`;
                        unlockTimeEl.classList.add('text-indigo-400');
                        unlockTimeEl.classList.remove('text-green-400');
                        fulfillDelayedWithdrawalButton.disabled = true;
                    }

                } else {
                    requestSection.classList.remove('hidden');
                    manageSection.classList.add('hidden');
                }
            } catch (error) {
                console.error("Błąd sprawdzania statusu wypłaty:", error);
            }
        }
        
        async function updateStaticInfo() {
            try {
                const fee = await vaultContract.instantWithdrawalFeeBps();
                feeInfoEl.textContent = (fee / 100).toFixed(2);
                const delay = await vaultContract.withdrawalDelayPeriod();
                delayInfoEl.textContent = formatTime(delay.toNumber());
            } catch(e) {
                console.error("Błąd pobierania statycznych danych", e);
            }
        }

        async function handleTransaction(txPromise, successMessage) {
            try {
                showStatus("Oczekiwanie na transakcję...");
                const tx = await txPromise;
                showStatus("Przetwarzanie transakcji...");
                await tx.wait();
                showStatus(successMessage, false, true);
                await updateAllData();
            } catch (error) {
                console.error("Błąd transakcji:", error);
                const reason = error.reason || "Transakcja odrzucona";
                showStatus(`Błąd: ${reason}`, true, true);
            }
        }

        async function handleApprove() {
            const amount = depositAmountInput.value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus("Wprowadź poprawną kwotę", true, true);
                return;
            }
            const usdcDecimals = await usdcContract.decimals();
            const amountInWei = ethers.utils.parseUnits(amount, usdcDecimals);
            
            const transactionOverrides = {
                maxPriorityFeePerGas: ethers.utils.parseUnits('1', 'gwei'),
                maxFeePerGas: ethers.utils.parseUnits('30', 'gwei'),
            };

            await handleTransaction(
                usdcContract.approve(vaultContractAddress, amountInWei, transactionOverrides),
                "Zatwierdzono pomyślnie!"
            );
        }

        async function handleDeposit() {
            const amount = depositAmountInput.value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus("Wprowadź poprawną kwotę", true, true);
                return;
            }
            const usdcDecimals = await usdcContract.decimals();
            const amountInWei = ethers.utils.parseUnits(amount, usdcDecimals);

            const transactionOverrides = {
                maxPriorityFeePerGas: ethers.utils.parseUnits('1', 'gwei'),
                maxFeePerGas: ethers.utils.parseUnits('30', 'gwei'),
            };

            await handleTransaction(
                vaultContract.deposit(amountInWei, userAddress, transactionOverrides),
                "Wpłata zakończona sukcesem!"
            );
            depositAmountInput.value = "";
        }
        
        async function handleInstantWithdraw() {
            const amount = instantWithdrawAmountInput.value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus("Wprowadź poprawną kwotę", true, true);
                return;
            }
            const usdcDecimals = await usdcContract.decimals();
            const amountInWei = ethers.utils.parseUnits(amount, usdcDecimals);

            const transactionOverrides = {
                maxPriorityFeePerGas: ethers.utils.parseUnits('1', 'gwei'),
                maxFeePerGas: ethers.utils.parseUnits('30', 'gwei'),
            };

            await handleTransaction(
                vaultContract.instantWithdrawal(amountInWei, transactionOverrides),
                "Natychmiastowa wypłata zakończona!"
            );
            instantWithdrawAmountInput.value = "";
        }

        async function handleRequestDelayedWithdraw() {
            const amount = delayedWithdrawAmountInput.value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus("Wprowadź poprawną kwotę", true, true);
                return;
            }
            const usdcDecimals = await usdcContract.decimals();
            const amountInWei = ethers.utils.parseUnits(amount, usdcDecimals);

            const transactionOverrides = {
                maxPriorityFeePerGas: ethers.utils.parseUnits('1', 'gwei'),
                maxFeePerGas: ethers.utils.parseUnits('30', 'gwei'),
            };

            await handleTransaction(
                vaultContract.requestDelayedWithdrawal(amountInWei, transactionOverrides),
                "Wniosek o wypłatę złożony!"
            );
            delayedWithdrawAmountInput.value = "";
        }
        
        async function handleFulfillDelayedWithdraw() {
            const transactionOverrides = {
                maxPriorityFeePerGas: ethers.utils.parseUnits('1', 'gwei'),
                maxFeePerGas: ethers.utils.parseUnits('30', 'gwei'),
            };
            await handleTransaction(
                vaultContract.fulfillDelayedWithdrawal(transactionOverrides),
                "Środki zostały wypłacone!"
            );
        }

        async function handleCancelDelayedWithdraw() {
            const transactionOverrides = {
                maxPriorityFeePerGas: ethers.utils.parseUnits('1', 'gwei'),
                maxFeePerGas: ethers.utils.parseUnits('30', 'gwei'),
            };
            await handleTransaction(
                vaultContract.cancelDelayedWithdrawal(transactionOverrides),
                "Wniosek o wypłatę anulowany."
            );
        }

        async function handleTransferToManager() {
            const amount = transferToManagerAmountInput.value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus("Wprowadź poprawną kwotę", true, true);
                return;
            }
            const usdcDecimals = await usdcContract.decimals();
            const amountInWei = ethers.utils.parseUnits(amount, usdcDecimals);

            const transactionOverrides = {
                maxPriorityFeePerGas: ethers.utils.parseUnits('1', 'gwei'),
                maxFeePerGas: ethers.utils.parseUnits('30', 'gwei'),
            };
            await handleTransaction(
                vaultContract.transferAssetsToFundManager(amountInWei, transactionOverrides),
                "Środki przekazane do Fund Managera!"
            );
            transferToManagerAmountInput.value = "";
        }

        async function handleUpdateOffChainBalance() {
            const amount = offChainBalanceAmountInput.value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus("Wprowadź poprawną kwotę", true, true);
                return;
            }
            const usdcDecimals = await usdcContract.decimals();
            const amountInWei = ethers.utils.parseUnits(amount, usdcDecimals);

            const transactionOverrides = {
                maxPriorityFeePerGas: ethers.utils.parseUnits('1', 'gwei'),
                maxFeePerGas: ethers.utils.parseUnits('30', 'gwei'),
            };
            await handleTransaction(
                vaultContract.updateOffChainAssetValue(amountInWei, transactionOverrides),
                "Off-Chain Balance zaktualizowany!"
            );
            offChainBalanceAmountInput.value = "";
        }

        function switchTab(tab) {
            if (tab === 'instant') {
                tabInstant.classList.add('tab-active');
                tabInstant.classList.remove('tab-inactive');
                tabDelayed.classList.add('tab-inactive');
                tabDelayed.classList.remove('tab-active');
                instantWithdrawPanel.classList.remove('hidden');
                delayedWithdrawPanel.classList.add('hidden');
            } else {
                tabDelayed.classList.add('tab-active');
                tabDelayed.classList.remove('tab-inactive');
                tabInstant.classList.add('tab-inactive');
                tabInstant.classList.remove('tab-active');
                delayedWithdrawalPanel.classList.remove('hidden');
                instantWithdrawPanel.classList.add('hidden');
            }
        }

        function showStatus(message, isError = false, autoHide = false) {
            statusText.textContent = message;
            statusMessage.classList.remove('hidden');
            statusMessage.classList.remove('border-red-500', 'border-green-500', 'border-blue-500');
            statusSpinner.classList.remove('hidden');
            statusMessage.classList.add('animate-pulse');

            if (isError) {
                statusMessage.classList.add('border-red-500');
                statusSpinner.classList.add('hidden');
            } else if (autoHide) {
                statusMessage.classList.add('border-green-500');
                statusSpinner.classList.add('hidden');
            } else {
                statusMessage.classList.add('border-blue-500');
            }

            if (autoHide) {
                statusMessage.classList.remove('animate-pulse');
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 5000);
            }
        }

        function formatTime(seconds) {
            const d = Math.floor(seconds / (3600 * 24));
            const h = Math.floor(seconds % (3600 * 24) / 3600);
            const m = Math.floor(seconds % 3600 / 60);
            const s = Math.floor(seconds % 60);
            
            let result = '';
            if (d > 0) result += `${d}d `;
            if (h > 0) result += `${h}h `;
            if (m > 0) result += `${m}m `;
            if (s > 0) result += `${s}s`;
            return result.trim();
        }

    </script>
</body>
</html>

